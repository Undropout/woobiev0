<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Woobie Admin Panel</title>
  <link rel="stylesheet" href="../shared/style.css">
  <style>
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    .search-box {
      margin-bottom: 2rem;
    }
    .search-box input {
      width: 100%;
      padding: 0.8rem;
      background: #000;
      border: 1px solid #33ff33;
      color: #33ff33;
      font-size: 1rem;
      border-radius: 5px;
    }
    .matches-list {
      margin-bottom: 2rem;
    }
    .match-item {
      padding: 1rem;
      margin-bottom: 0.5rem;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid #666;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .match-item:hover {
      border-color: #33ff33;
      background: rgba(51, 255, 51, 0.1);
    }
    .match-item.selected {
      border-color: #00ffff;
      background: rgba(0, 255, 255, 0.1);
    }
    .match-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .match-users {
      font-weight: bold;
      color: #00ffff;
    }
    .match-stage {
      color: #999;
      font-size: 0.9rem;
    }
    .chat-viewer {
      display: none;
      padding: 1.5rem;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #33ff33;
      border-radius: 5px;
      max-height: 600px;
      overflow-y: auto;
    }
    .chat-viewer.active {
      display: block;
    }
    .chat-message {
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      background: rgba(51, 255, 51, 0.05);
      border-left: 3px solid #33ff33;
      border-radius: 3px;
    }
    .chat-message.flagged {
      border-left-color: #ff3333;
      background: rgba(255, 51, 51, 0.1);
    }
    .chat-sender {
      font-weight: bold;
      color: #00ffff;
      margin-bottom: 0.3rem;
    }
    .chat-text {
      color: #33ff33;
      margin-bottom: 0.3rem;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .chat-timestamp {
      color: #666;
      font-size: 0.85rem;
    }
    .no-chat {
      color: #999;
      text-align: center;
      padding: 2rem;
    }
    .loading {
      text-align: center;
      color: #33ff33;
      padding: 2rem;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      padding: 1rem;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid #666;
      border-radius: 5px;
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #00ffff;
    }
    .stat-label {
      color: #999;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <h1>üõ°Ô∏è Woobie Admin Panel</h1>

    <div id="auth-check" class="loading">
      Checking authentication...
    </div>

    <div id="admin-content" style="display:none;">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="total-matches">-</div>
          <div class="stat-label">Total Matches</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-messages">-</div>
          <div class="stat-label">Total Messages</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="active-chats">-</div>
          <div class="stat-label">Active Chats</div>
        </div>
      </div>

      <div class="search-box">
        <input type="text" id="search-input" placeholder="Search matches by ID, username, or stage...">
      </div>

      <h2>Matches</h2>
      <div id="matches-list" class="matches-list loading">
        Loading matches...
      </div>

      <div id="chat-viewer" class="chat-viewer">
        <h3 id="chat-title">Chat History</h3>
        <div id="chat-messages"></div>
      </div>

      <button id="logout-button" class="woobie-button" style="margin-top: 2rem;">üö™ Log out</button>
    </div>
  </div>

  <script type="module">
    import { db, auth } from '../shared/firebase-config.js';
    import { ref, onValue, get } from 'firebase/database';
    import { onAuthStateChanged, signOut } from 'firebase/auth';

    // Admin email whitelist - CHANGE THIS TO YOUR EMAIL
    const ADMIN_EMAILS = [
      'friends@woobie.fun', // Replace with your admin email(s)
    ];

    let allMatches = [];
    let selectedMatchId = null;

    const authCheckEl = document.getElementById('auth-check');
    const adminContentEl = document.getElementById('admin-content');
    const matchesListEl = document.getElementById('matches-list');
    const chatViewerEl = document.getElementById('chat-viewer');
    const chatMessagesEl = document.getElementById('chat-messages');
    const chatTitleEl = document.getElementById('chat-title');
    const searchInput = document.getElementById('search-input');
    const logoutButton = document.getElementById('logout-button');

    // Logout
    if (logoutButton) {
      logoutButton.onclick = async () => {
        await signOut(auth);
        window.location.href = '/auth/login.html';
      };
    }

    // Check admin access
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        authCheckEl.textContent = 'Not authenticated. Redirecting to login...';
        setTimeout(() => window.location.href = '/auth/login.html', 2000);
        return;
      }

      // Check if user is admin
      if (!ADMIN_EMAILS.includes(user.email)) {
        authCheckEl.textContent = `Access denied. Only administrators can access this page.`;
        authCheckEl.style.color = '#ff3333';
        return;
      }

      // User is admin, show content
      authCheckEl.style.display = 'none';
      adminContentEl.style.display = 'block';
      loadMatches();
    });

    // Load all matches
    async function loadMatches() {
      try {
        const matchesRef = ref(db, 'matches');
        const snapshot = await get(matchesRef);

        if (!snapshot.exists()) {
          matchesListEl.innerHTML = '<p class="no-chat">No matches found.</p>';
          return;
        }

        const matchesData = snapshot.val();
        allMatches = Object.entries(matchesData).map(([matchId, data]) => ({
          matchId,
          ...data
        }));

        // Calculate stats
        document.getElementById('total-matches').textContent = allMatches.length;

        let totalMessages = 0;
        let activeChats = 0;
        allMatches.forEach(match => {
          if (match.chat) {
            const msgCount = Object.keys(match.chat).length;
            totalMessages += msgCount;
            if (msgCount > 0) activeChats++;
          }
        });

        document.getElementById('total-messages').textContent = totalMessages;
        document.getElementById('active-chats').textContent = activeChats;

        displayMatches(allMatches);
      } catch (error) {
        console.error('Error loading matches:', error);
        matchesListEl.innerHTML = '<p style="color:#ff3333;">Error loading matches.</p>';
      }
    }

    // Display matches
    function displayMatches(matches) {
      if (matches.length === 0) {
        matchesListEl.innerHTML = '<p class="no-chat">No matches found.</p>';
        return;
      }

      matchesListEl.innerHTML = matches.map(match => {
        const users = match.users ? Object.values(match.users).join(' & ') : 'Unknown users';
        const messageCount = match.chat ? Object.keys(match.chat).length : 0;
        const stage = getStageFromMatch(match);

        return `
          <div class="match-item" data-match-id="${match.matchId}">
            <div class="match-info">
              <div>
                <div class="match-users">${users}</div>
                <div class="match-stage">Match ID: ${match.matchId}</div>
                <div class="match-stage">Stage: ${stage} | Messages: ${messageCount}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Add click listeners
      document.querySelectorAll('.match-item').forEach(item => {
        item.addEventListener('click', () => {
          const matchId = item.dataset.matchId;
          selectMatch(matchId);
        });
      });
    }

    // Get current stage from match data
    function getStageFromMatch(match) {
      // Check various tier completions to determine stage
      if (match.chat && Object.keys(match.chat).length > 0) return 'chatroom';
      if (match.tier3) return 'tier3';
      if (match.tier2) return 'tier2';
      if (match.tier1b) return 'tier1b';
      if (match.tier1a) return 'tier1a';
      if (match.bios) return 'bio';
      return 'created';
    }

    // Select and display match chat
    function selectMatch(matchId) {
      selectedMatchId = matchId;

      // Update selected state
      document.querySelectorAll('.match-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.matchId === matchId);
      });

      const match = allMatches.find(m => m.matchId === matchId);
      if (!match) return;

      const users = match.users ? Object.values(match.users).join(' & ') : 'Unknown users';
      chatTitleEl.textContent = `Chat: ${users} (${matchId})`;

      if (!match.chat || Object.keys(match.chat).length === 0) {
        chatMessagesEl.innerHTML = '<p class="no-chat">No messages in this chat yet.</p>';
        chatViewerEl.classList.add('active');
        return;
      }

      // Display messages
      const messages = Object.entries(match.chat).map(([msgId, msg]) => ({
        msgId,
        ...msg
      }));

      // Sort by timestamp
      messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

      // Check for potentially problematic content
      const flaggedWords = ['slur', 'nigger', 'nigga', 'faggot', 'retard', 'kys', 'kill yourself'];

      chatMessagesEl.innerHTML = messages.map(msg => {
        const text = msg.text || '';
        const isFlagged = flaggedWords.some(word =>
          text.toLowerCase().includes(word.toLowerCase())
        );

        const timestamp = msg.timestamp ? new Date(msg.timestamp).toLocaleString() : 'Unknown time';

        return `
          <div class="chat-message ${isFlagged ? 'flagged' : ''}">
            <div class="chat-sender">${msg.sender || 'Unknown'}</div>
            <div class="chat-text">${escapeHtml(text)}</div>
            <div class="chat-timestamp">${timestamp}${isFlagged ? ' ‚ö†Ô∏è FLAGGED' : ''}</div>
          </div>
        `;
      }).join('');

      chatViewerEl.classList.add('active');
      chatViewerEl.scrollTop = 0;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Search functionality
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();

        if (!query) {
          displayMatches(allMatches);
          return;
        }

        const filtered = allMatches.filter(match => {
          const matchId = match.matchId.toLowerCase();
          const users = match.users ? Object.values(match.users).join(' ').toLowerCase() : '';
          const stage = getStageFromMatch(match).toLowerCase();

          return matchId.includes(query) || users.includes(query) || stage.includes(query);
        });

        displayMatches(filtered);
      });
    }
  </script>
</body>
</html>
