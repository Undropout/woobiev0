<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Our Story</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    details {
      margin-bottom: 1rem;
      border: 1px solid #33ff33;
      border-radius: 5px;
      padding: 0.5rem;
      background-color: #000;
      color: #fff;
    }
    summary {
      cursor: pointer;
      font-weight: bold;
      color: #33ff33;
    }
    summary::-webkit-details-marker {
      display: none;
    }
    details[open] summary::after {
      content: "â–²";
      float: right;
    }
    details summary::after {
      content: "â–¼";
      float: right;
    }
    p {
      margin: 0.25rem 0 0.5rem;
    }
    img.greyscale {
      image-rendering: pixelated;
      width: auto;
      height: auto;
      max-width: 100%;
      max-height: 150px;
      filter: grayscale(100%) contrast(150%) saturate(0%);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“– Our Story</h1>
    <div id="timeline"></div>
  </div>

  <script type="module">
    import { db, auth } from '../shared/firebase-config.js';
    import { ref, get } from 'firebase/database';
    import { onAuthStateChanged } from 'firebase/auth';

    const matchID = localStorage.getItem('woobieMatchID');
    const timeline = document.getElementById('timeline');

    const tierLabelMap = {
      tier1a: '1A',
      tier1b: '1B',
      tier2: '2',
      tier3: '3'
    };

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        timeline.innerHTML = '<p style="color:#ff6666;">You must be logged in to view your story.</p>';
        return;
      }

      const currentUserId = user.uid;
      if (!matchID) {
        timeline.innerHTML = '<p style="color:#ff6666;">No match ID found.</p>';
        return;
      }

      // Get users data to map UIDs to usernames
      const usersSnap = await get(ref(db, `matches/${matchID}/users`));
      const usersData = usersSnap.val() || {};
      const partnerUID = Object.keys(usersData).find(uid => uid !== currentUserId);

      if (!partnerUID) {
        timeline.innerHTML = '<p style="color:#ff6666;">Partner data not found.</p>';
        return;
      }

      const myUsername = usersData[currentUserId];
      const partnerUsername = usersData[partnerUID];

      // Get modes data (stored by UID)
      const modesSnap = await get(ref(db, `matches/${matchID}/modes`));
      const modesData = modesSnap.val() || {};

      // Map modes by username for rendering
      const modesByUsername = {};
      modesByUsername[myUsername] = modesData[currentUserId]?.mode || 'normal';
      modesByUsername[partnerUsername] = modesData[partnerUID]?.mode || 'normal';

      function renderStyledName(name, mode) {
        return `<strong class="woobie-${mode}">${name}</strong>`;
      }

      const sections = [
        {
          key: 'bios',
          label: 'ðŸ§¬ Bios',
          render: (data) => {
            return `<p>${renderStyledName(myUsername, modesByUsername[myUsername])}: ${data[currentUserId] || '(no bio)'}</p>
                    <p>${renderStyledName(partnerUsername, modesByUsername[partnerUsername])}: ${data[partnerUID] || '(no bio)'}</p>`;
          }
        },
        ...['tier1a', 'tier1b', 'tier2', 'tier3'].map(key => ({
          key,
          label: `Tier ${tierLabelMap[key]} Answers`,
          render: (data) => {
            let out = '';
            const myRaw = data[currentUserId];
            const theirRaw = data[partnerUID];

            const myAnswers = Array.isArray(myRaw)
              ? myRaw
              : Array.isArray(myRaw?.answers)
                ? myRaw.answers
                : [];

            const theirAnswers = Array.isArray(theirRaw)
              ? theirRaw
              : Array.isArray(theirRaw?.answers)
                ? theirRaw.answers
                : [];

            if (!myAnswers.length && !theirAnswers.length) {
              return '<p>(No answers available yet)</p>';
            }

            myAnswers.forEach((ans, i) => {
              out += `<p><strong>Q${i + 1}</strong></p>`;
              out += `<p>${renderStyledName(myUsername, modesByUsername[myUsername])}: ${ans?.value || ans || ''}</p>`;
              out += `<p>${renderStyledName(partnerUsername, modesByUsername[partnerUsername])}: ${theirAnswers[i]?.value || theirAnswers[i] || ''}</p>`;
            });

            return out;
          }
        })),
        {
          key: 'tier1bLetters',
          label: 'ðŸ’Œ Tier 1B Letters',
          render: (data) => {
            return `<details><summary>${renderStyledName(myUsername, modesByUsername[myUsername])}'s Letter</summary><p>${data[currentUserId] || '(no message)'}</p></details>
                    <details><summary>${renderStyledName(partnerUsername, modesByUsername[partnerUsername])}'s Letter</summary><p>${data[partnerUID] || '(no message)'}</p></details>`;
          }
        },
        {
          key: 'tier2Rewards',
          label: 'ðŸŽ Tier 2 Rewards',
          render: (data) => {
            const mine = data[currentUserId] || {};
            const theirs = data[partnerUID] || {};
            let out = '';

            if (mine.text || mine.imageURL || mine.audioURL) {
              out += `<details><summary>${renderStyledName(myUsername, modesByUsername[myUsername])}'s Reward</summary>`;
              if (mine.text) out += `<p><strong>Text:</strong> ${mine.text}</p>`;
              if (mine.imageURL) out += `<p><img class="greyscale" src="${mine.imageURL}" alt="${mine.alt || 'image'}" /></p>`;
              if (mine.audioURL) out += `<p><audio controls src="${mine.audioURL}"></audio></p>`;
              out += `</details>`;
            }

            if (theirs.text || theirs.imageURL || theirs.audioURL) {
              out += `<details><summary>${renderStyledName(partnerUsername, modesByUsername[partnerUsername])}'s Reward</summary>`;
              if (theirs.text) out += `<p><strong>Text:</strong> ${theirs.text}</p>`;
              if (theirs.imageURL) out += `<p><img class="greyscale" src="${theirs.imageURL}" alt="${theirs.alt || 'image'}" /></p>`;
              if (theirs.audioURL) out += `<p><audio controls src="${theirs.audioURL}"></audio></p>`;
              out += `</details>`;
            }

            return out || '<p>(No rewards found)</p>';
          }
        }
      ];

      for (const section of sections) {
        const refPath =
          section.key === 'tier2Rewards'
            ? `matches/${matchID}/tier2Rewards`
            : `matches/${matchID}/${section.key}`;

        const dataRef = ref(db, refPath);
        get(dataRef).then(snap => {
          const data = snap.val();
          if (!data || Object.keys(data).length < 1) return;

          const block = document.createElement('details');
          const summary = document.createElement('summary');
          summary.textContent = section.label;
          block.appendChild(summary);

          const content = document.createElement('div');
          try {
            content.innerHTML = section.render(data);
          } catch (err) {
            content.innerHTML = '<p style="color:#ff6666">Error displaying this section.</p>';
            console.error('Error rendering section:', err);
          }

          block.appendChild(content);
          timeline.appendChild(block);
        });
      }
    });
  </script>
</body>
</html>
