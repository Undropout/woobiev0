<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bio Reveal</title>
  <link rel="stylesheet" href="../shared/style.css" />
</head>
<body>
  <div class="container">
    <h1>üß¨ Get to Know Each Other</h1>
    <p>You both chose to continue! Here's a glimpse of each other:</p>

    <div id="bios">
      <p>Loading bios...</p>
    </div>

    <button class="woobie-button" id="continue-btn" style="display:none;"><span class="woobie-emoji">‚Üí</span> Continue to Tier 1b</button>
  </div>

  <script type="module">
    import { db, auth } from '../shared/firebase-config.js';
    import { ref, get, update, onValue } from 'firebase/database';
    import { onAuthStateChanged } from 'firebase/auth';

    const biosDiv = document.getElementById('bios');
    const continueBtn = document.getElementById('continue-btn');
    let matchID;

    // Emoji replacement function for woobiecore aesthetic
    function replaceEmojiWithMonochrome(text) {
      // Wrap emoji in spans with monochrome styling
      return text.replace(/(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)/gu, (match) => {
        return `<span class="woobie-emoji">${match}</span>`;
      });
    }

    async function renderBios(currentUserId, localWoobieUsername) {
      try {
        const allBiosRef = ref(db, `matches/${matchID}/bios`);
        const biosSnap = await get(allBiosRef);
        const allBiosData = biosSnap.val();

        if (!allBiosData || Object.keys(allBiosData).length < 2) {
          biosDiv.innerHTML = '<p>Waiting for your match to submit their bio...</p>';
          const unsubscribe = onValue(allBiosRef, (snapshot) => {
              const updatedBios = snapshot.val();
              if (updatedBios && Object.keys(updatedBios).length >= 2) {
                  unsubscribe();
                  renderBios(currentUserId, localWoobieUsername);
              }
          }, (error) => {
              console.error("Error listening to bios:", error);
              biosDiv.innerHTML = '<p style="color:#ff6666;">Error waiting for match data. Please try refreshing.</p>';
          });
          return;
        }

        const partnerUID = Object.keys(allBiosData).find(uidKey => uidKey !== currentUserId);

        if (!partnerUID || !allBiosData[currentUserId] || !allBiosData[partnerUID]) {
            biosDiv.innerHTML = '<p>Error: Could not retrieve complete bio information for both users. Waiting for updates...</p>';
            const unsubscribeOnError = onValue(allBiosRef, (snapshot) => {
                const updatedBios = snapshot.val();
                if (updatedBios && Object.keys(updatedBios).length >= 2 && updatedBios[currentUserId] && updatedBios[Object.keys(updatedBios).find(uidKey => uidKey !== currentUserId)]) {
                    unsubscribeOnError();
                    renderBios(currentUserId, localWoobieUsername);
                }
            });
            return;
        }

        const [myProfileSnap, theirProfileSnap, usersNodeSnap] = await Promise.all([
          get(ref(db, `matches/${matchID}/profiles/${currentUserId}`)),
          get(ref(db, `matches/${matchID}/profiles/${partnerUID}`)),
          get(ref(db, `matches/${matchID}/users`))
        ]);

        const myProfileData = myProfileSnap.val() || {};
        const theirProfileData = theirProfileSnap.val() || {};
        const usersNodeData = usersNodeSnap.val() || {};
        
        const myDisplayName = usersNodeData[currentUserId] || localWoobieUsername || "You";
        const partnerDisplayName = usersNodeData[partnerUID] || "Your Match";

        const formatList = arr =>
          Array.isArray(arr) && arr.length
            ? `${arr.map(item => `<li>${item}</li>`).join('')}`
            : '<li><i>None listed</i></li>';

        // Apply emoji replacement to all content before rendering
        const processedPartnerBio = replaceEmojiWithMonochrome(allBiosData[partnerUID]);
        const processedMyBio = replaceEmojiWithMonochrome(allBiosData[currentUserId]);
        const processedPartnerName = replaceEmojiWithMonochrome(partnerDisplayName);
        const processedMyName = replaceEmojiWithMonochrome(myDisplayName);
        
        biosDiv.innerHTML = `
          <div style="border:1px solid #33ff33; padding:1rem; margin-bottom:1rem;">
            <h2>${processedPartnerName}'s Bio:</h2>
            <p>${processedPartnerBio}</p>
            <h4>üéØ Interests: üéØ</h4>
            <ul style="list-style: none; padding: 0; text-align: center;">${formatList(theirProfileData.interests)}</ul>
            <h4>‚ùå Dealbreakers: ‚ùå</h4>
            <ul style="list-style: none; padding: 0; text-align: center;">${formatList(theirProfileData.dealbreakers)}</ul>
          </div>
          <div style="border:1px solid #999999; padding:1rem;">
            <h2>${processedMyName}'s Bio:</h2>
            <p>${processedMyBio}</p>
            <h4>üéØ Interests: üéØ</h4>
            <ul style="list-style: none; padding: 0; text-align: center;">${formatList(myProfileData.interests)}</ul>
            <h4>‚ùå Dealbreakers: ‚ùå</h4>
            <ul style="list-style: none; padding: 0; text-align: center;">${formatList(myProfileData.dealbreakers)}</ul>
          </div>
        `;

        continueBtn.style.display = 'block';
        
        // Apply emoji replacement to header and button elements after a short delay to ensure font loads
        setTimeout(() => {
          document.querySelector('h1').innerHTML = replaceEmojiWithMonochrome(document.querySelector('h1').textContent);
          
          // Manually process the button since it has ASCII arrow, not Unicode emoji
          continueBtn.innerHTML = `<span class="woobie-emoji">‚Üí</span> Continue to Tier 1b`;
          
          // Apply emoji replacement to the interest/dealbreaker headers
          document.querySelectorAll('h4').forEach(header => {
            header.innerHTML = replaceEmojiWithMonochrome(header.textContent);
          });
        }, 100);
      } catch (err) {
        console.error("Failed to load bios or profiles:", err);
        biosDiv.innerHTML = '<p style="color:#ff6666;">Failed to load bio information. Please try again later.</p>';
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        biosDiv.innerHTML = '<p>Not logged in. Please reload or sign in again. Redirecting...</p>';
        continueBtn.style.display = 'none';
        setTimeout(() => window.location.href = '/auth/login.html', 2000);
        return;
      }
      
      const currentUserIdFromAuth = user.uid;
      let localWoobieUsernameFromLS = localStorage.getItem('woobieUsername');
      matchID = localStorage.getItem('woobieMatchID');

      if (!matchID) {
        biosDiv.innerHTML = '<p style="color:#ff6666;">Missing Match ID. Please restart the process.</p>';
        continueBtn.style.display = 'none';
        setTimeout(() => window.location.href = '/name-picker/index.html', 2500);
        return;
      }

      if (!localWoobieUsernameFromLS) {
         try {
           const userCurrentMatchSnap = await get(ref(db, `users/${currentUserIdFromAuth}/currentMatch`));
           const userCurrentMatchData = userCurrentMatchSnap.val();
           if (userCurrentMatchData && userCurrentMatchData.username) {
              localWoobieUsernameFromLS = userCurrentMatchData.username;
              localStorage.setItem('woobieUsername', localWoobieUsernameFromLS);
           } else {
              biosDiv.innerHTML = '<p style="color:#ff6666;">Missing Woobie name. Please restart by picking a name.</p>';
              setTimeout(() => window.location.href = '/name-picker/index.html', 2500);
              return;
           }
         } catch (err) {
            console.error("Error fetching Woobie name from profile:", err);
            biosDiv.innerHTML = '<p style="color:#ff6666;">Could not retrieve session details. Please restart.</p>';
            setTimeout(() => window.location.href = '/name-picker/index.html', 2500);
            return;
         }
      }
      
      await renderBios(currentUserIdFromAuth, localWoobieUsernameFromLS);

      const userMatchProgressRef = ref(db, `users/${currentUserIdFromAuth}/currentMatch`);
      await update(userMatchProgressRef, { stage: 'tier1a-bios-revealed' });
    });

    continueBtn.onclick = async () => {
      window.location.href = '/tier1b/index.html';
    };
  </script>
</body>
</html>