<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Write Your Bio</title>
  <link rel="stylesheet" href="../shared/style.css" />
</head>
<body>
  <div class="container">
    <h1>Write a Short Bio ðŸ“˜</h1>
    <p>This will help your match get to know you.</p>
    <p>Your partner won't <i>receive</i> your bio unless you vote to continue after the first six questions.</p>
    <p> Max 250 words.</p>
    <textarea id="bio-input" rows="8" placeholder="Write a little about yourself..."></textarea>
    <p id="bio-count">0 / 250 words</p>
    <p id="bio-warning" style="color: #ff6666"></p>
    <button id="submit-bio" class="woobie-button">Submit â†’</button>
  </div>
  
  <script type="module">
    import { db, auth } from '../shared/firebase-config.js';
    import { ref, set, update } from 'firebase/database';
    import { onAuthStateChanged } from 'firebase/auth';

    // Emoji replacement function for woobiecore aesthetic
    function replaceEmojiWithMonochrome(text) {
      return text.replace(/(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)/gu, (match) => {
        return `<span class="woobie-emoji">${match}</span>`;
      });
    }

    // Apply emoji replacement to page elements
    document.addEventListener('DOMContentLoaded', () => {
      // Process title
      const title = document.querySelector('h1');
      title.innerHTML = replaceEmojiWithMonochrome(title.textContent);
      
      // Process submit button - manually handle the arrow
      const submitBtn = document.getElementById('submit-bio');
      submitBtn.innerHTML = `Submit <span class="woobie-emoji">â†’</span>`;
    });

    const input = document.getElementById('bio-input');
    const count = document.getElementById('bio-count');
    const warning = document.getElementById('bio-warning');
    const button = document.getElementById('submit-bio');
    
    input.addEventListener('input', () => {
      const words = input.value.trim().split(/\s+/).filter(Boolean);
      count.textContent = `${words.length} / 250 words`;
      if (words.length > 250) {
        warning.textContent = 'Too many words! Please stay under 250.';
        button.disabled = true;
      } else {
        warning.textContent = '';
        button.disabled = false;
      }
    });
    
    button.onclick = async () => {
      const text = input.value.trim();
      const words = text.split(/\s+/).filter(Boolean);
      const repeated = /(.)\1{20,}/.test(text);
      if (words.length > 250 || repeated) {
        warning.textContent = 'Please shorten your bio and avoid repeated characters.';
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        warning.textContent = "You're not logged in. Please log in again.";
        return;
      }

      button.disabled = true;
      warning.textContent = 'Submitting...';
      warning.style.color = '#33ff33';

      try {
        // Get matchID from localStorage first, fallback to database
        let matchID = localStorage.getItem('woobieMatchID');

        if (!matchID) {
          // Fetch from database
          const { get } = await import('firebase/database');
          const userSnap = await get(ref(db, `users/${user.uid}/currentMatch`));
          const matchData = userSnap.val();

          if (!matchData || !matchData.matchID) {
            warning.textContent = "No match found. Please restart from the beginning.";
            warning.style.color = '#ff6666';
            button.disabled = false;
            return;
          }

          matchID = matchData.matchID;
          localStorage.setItem('woobieMatchID', matchID);
          if (matchData.username) {
            localStorage.setItem('woobieUsername', matchData.username);
          }
        }

        localStorage.setItem('woobieBio', text);

        const bioRef = ref(db, `matches/${matchID}/bios/${user.uid}`);
        await set(bioRef, text);

        const matchProgressRef = ref(db, `users/${user.uid}/currentMatch`);
        await update(matchProgressRef, {
          stage: 'tier1a'
        });

        window.location.href = '/tier1a/index.html';
      } catch (err) {
        console.error('Error submitting bio:', err);
        warning.textContent = 'Error submitting bio. Please try again.';
        warning.style.color = '#ff6666';
        button.disabled = false;
      }
    };
  </script>
  <script type="module" src="../shared/logout.js"></script>
</body>
</html>