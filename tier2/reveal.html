<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tier 2 Reward Reveal</title>
  <link rel="stylesheet" href="../shared/style.css" />
</head>
<body>
  <div class="container">
    <h1>üè± See What Your Match Shared</h1>
    <button id="logout-button" class="woobie-button" style="float:right;">üö™ Log out</button>
    <p>You both completed Tier 2! Here's what your match chose to share with you:</p>

    <div id="reward-box">
      <p>Loading reward...</p>
    </div>

    <div id="vote-section" style="display:none; margin-top:2rem;">
      <h2>Would you like to continue to Tier 3?</h2>
      <button class="woobie-button" id="vote-yes">üëç Yes</button>
      <button class="woobie-button" id="vote-no">üëé No</button>
      <p id="vote-waiting" style="display:none;">Waiting for your match's vote...</p>
    </div>

    <!-- Our Story Modal -->
    <div id="our-story-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:black; overflow:auto; z-index:9999; padding:2rem;">
      <button id="close-story" class="woobie-button" style="position:absolute; top:1rem; right:1rem;">‚ùå Close</button>
      <h2 style="color:#33ff33">üìö Our Story So Far</h2>
      <div id="story-content"></div>
    </div>

    <div style="margin-top: 2rem; text-align:center;">
      <button id="our-story-button" class="woobie-button">üìñ Our Story So Far</button>
    </div>
  </div>

  <script type="module">
    import { db, auth } from '../shared/firebase-config.js';
    import { ref, get, set, update, onValue, off } from 'firebase/database';
    import { onAuthStateChanged, signOut } from 'firebase/auth';
    import '../shared/logout.js';

    // Emoji replacement function for woobiecore aesthetic
    function replaceEmojiWithMonochrome(text) {
      return text.replace(/(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)/gu, (match) => {
        return `<span class="woobie-emoji">${match}</span>`;
      });
    }

    // Apply emoji replacement to page elements
    document.addEventListener('DOMContentLoaded', () => {
      // Process main title
      const title = document.querySelector('h1');
      title.innerHTML = replaceEmojiWithMonochrome(title.textContent);
      
      // Process logout button
      const logoutBtn = document.getElementById('logout-button');
      logoutBtn.innerHTML = replaceEmojiWithMonochrome(logoutBtn.textContent);
      
      // Process vote buttons
      const voteYesBtn = document.getElementById('vote-yes');
      const voteNoBtn = document.getElementById('vote-no');
      voteYesBtn.innerHTML = replaceEmojiWithMonochrome(voteYesBtn.textContent);
      voteNoBtn.innerHTML = replaceEmojiWithMonochrome(voteNoBtn.textContent);

      // Process story modal elements
      const closeStoryBtn = document.getElementById('close-story');
      closeStoryBtn.innerHTML = replaceEmojiWithMonochrome(closeStoryBtn.textContent);

      const storyModalTitle = document.querySelector('#our-story-modal h2');
      storyModalTitle.innerHTML = replaceEmojiWithMonochrome(storyModalTitle.textContent);

      const storyBtn = document.getElementById('our-story-button');
      storyBtn.innerHTML = replaceEmojiWithMonochrome(storyBtn.textContent);
    });

    const logoutBtn = document.getElementById('logout-button');
    logoutBtn.onclick = async () => {
      const confirmLogout = confirm("Are you sure you want to log out? You'll lose your place unless you're logged in.");
      if (!confirmLogout) return;
      try {
        await signOut(auth);
      } catch (err) {
        console.warn("Firebase sign-out failed:", err);
      }
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = '/index.html';
    };

    const matchID = localStorage.getItem('woobieMatchID');

    const rewardBox = document.getElementById('reward-box');
    const voteYesBtn = document.getElementById('vote-yes');
    const voteNoBtn = document.getElementById('vote-no');
    const voteSection = document.getElementById('vote-section');
    const voteWaiting = document.getElementById('vote-waiting');

    let currentUserUID = null;
    let currentUsername = null;

    function renderReward(reward) {
      let html = '';
      if (reward.text) {
        html += `<h3>üìù Message</h3><p style="white-space:pre-line;">${reward.text}</p>`;
      }
      if (reward.imageURL) {
        html += `<h3>üñºÔ∏è Image</h3><img src="${reward.imageURL}" alt="${reward.alt || 'Image from your match'}" style="max-width:100%; border:1px solid #33ff33;" />`;
      }
      if (reward.audioURL) {
        html += `<h3>üîä Voice Message</h3><audio controls src="${reward.audioURL}"></audio>`;
      }
      
      // Apply emoji replacement to the dynamically generated content
      const processedHTML = replaceEmojiWithMonochrome(html);
      rewardBox.innerHTML = processedHTML || '<p>Your match sent an empty reward.</p>';
      voteSection.style.display = 'block';
    }

    async function loadReward() {
      if (!currentUserUID) return;
      
      try {
        const rewardRef = ref(db, `matches/${matchID}/tier2Rewards`);
        const snap = await get(rewardRef);
        const data = snap.val();
        
        // Find partner's UID (not username)
        const partnerUID = data ? Object.keys(data).find(k => k !== currentUserUID) : null;
        const reward = partnerUID ? data[partnerUID] : null;

        if (partnerUID && reward) {
          renderReward(reward);
        } else {
          rewardBox.innerHTML = '<p>Your match has not submitted a reward yet. Waiting...</p>';
          // Set up listener for when partner submits their reward
          const rewardListener = onValue(rewardRef, snap => {
            const data = snap.val();
            const partnerUID = data ? Object.keys(data).find(k => k !== currentUserUID) : null;
            const reward = partnerUID ? data[partnerUID] : null;
            if (partnerUID && reward) {
              renderReward(reward);
              off(rewardRef, rewardListener); // Remove listener once reward is loaded
            }
          });
        }
      } catch (err) {
        rewardBox.innerHTML = '<p style="color:#ff6666;">Failed to load reward.</p>';
        console.error('Error loading reward:', err);
      }
    }

    let listenerAttached = false;
    function waitForVotes() {
      voteYesBtn.style.display = 'none';
      voteNoBtn.style.display = 'none';
      voteWaiting.style.display = 'block';

      if (!listenerAttached) {
        listenerAttached = true;
        const allVotesRef = ref(db, `matches/${matchID}/tier2Votes`);
        const voteListener = onValue(allVotesRef, snap => {
          const votes = snap.val();
          if (!votes || Object.keys(votes).length < 2) return;
          const bothYes = Object.values(votes).every(v => v === true);
          off(allVotesRef, voteListener);
          window.location.href = bothYes ? '/tier3/index.html' : '/goodbye.html';
        });
      }
    }

    voteYesBtn.onclick = async () => {
      if (!currentUserUID) return;
      try {
        const voteRef = ref(db, `matches/${matchID}/tier2Votes/${currentUserUID}`);
        await set(voteRef, true);
        waitForVotes();
      } catch (err) {
        console.error('Error voting:', err);
        alert('Failed to submit vote. Please try again.');
      }
    };

    voteNoBtn.onclick = async () => {
      const confirmEnd = prompt("If you're sure you want to end the match, type 'Goodbye' to confirm.");
      if (confirmEnd?.trim().toLowerCase() === 'goodbye') {
        if (!currentUserUID) return;
        try {
          const voteRef = ref(db, `matches/${matchID}/tier2Votes/${currentUserUID}`);
          await set(voteRef, false);
          waitForVotes();
        } catch (err) {
          console.error('Error voting:', err);
          alert('Failed to submit vote. Please try again.');
        }
      }
    };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUserUID = user.uid;
        currentUsername = localStorage.getItem('woobieUsername');

        // Update user's current stage
        await update(ref(db, `users/${user.uid}/currentMatch`), { stage: 'tier2-reveal' });

        // Load reward now that we have the user UID
        loadReward();
      } else {
        window.location.href = '/auth/login.html';
      }
    });

    // Story modal functionality
    const storyBtn = document.getElementById('our-story-button');
    const closeBtn = document.getElementById('close-story');
    const storyContent = document.getElementById('story-content');
    const modal = document.getElementById('our-story-modal');

    if (storyBtn && modal && storyContent && closeBtn) {
      storyBtn.onclick = async () => {
        modal.style.display = 'block';
        storyContent.innerHTML = '<p>Loading...</p>';

        try {
          const user = auth.currentUser;
          if (!user || !matchID) {
            storyContent.innerHTML = '<p>Error loading story.</p>';
            return;
          }

          const currentUserId = user.uid;

          // Fetch tier1a, tier1b, and tier2 answers
          const [tier1aSnap, tier1bSnap, tier2Snap] = await Promise.all([
            get(ref(db, `matches/${matchID}/tier1a`)),
            get(ref(db, `matches/${matchID}/tier1b`)),
            get(ref(db, `matches/${matchID}/tier2`))
          ]);

          const tier1aData = tier1aSnap.val() || {};
          const tier1bData = tier1bSnap.val() || {};
          const tier2Data = tier2Snap.val() || {};

          const partnerUID = Object.keys(tier2Data).find(uid => uid !== currentUserId);
          if (!partnerUID) {
            storyContent.innerHTML = '<p>Waiting for your match to complete their answers...</p>';
            return;
          }

          const tier1aQuestions = [
            "What's something you're proud of recently?",
            "How would a friend describe you?",
            "What does comfort look like to you?",
            "When do you feel most alive?",
            "What's a recent thought you can't shake?",
            "How do you usually show someone you care?"
          ];

          const tier1bQuestions = [
            "What's something you're working on improving?",
            "How do you recharge after a stressful day?",
            "What's a non-negotiable value in your life?",
            "What do you want more of in your future?",
            "What makes you feel heard?",
            "What's a memory you'd share to explain who you are?"
          ];

          const tier2Questions = [
            "What's a moment in your life that changed the way you see the world?",
            "How do you show someone you care about them?",
            "What's something people often misunderstand about you?",
            "When do you feel most like yourself?",
            "What's one thing you wish more people asked you about?",
            "What makes you feel seen or understood?",
            "What's a belief you held strongly that changed over time?",
            "What's one thing you never get tired of talking about?",
            "When have you felt the most brave?",
            "What do you wish someone had told you earlier in life?",
            "What kind of people do you feel safest around?",
            "What's something you've forgiven yourself for?"
          ];

          let html = '<h3>üìò Tier 1a Answers</h3>';
          const myTier1a = tier1aData[currentUserId]?.answers || [];
          const theirTier1a = tier1aData[partnerUID]?.answers || [];

          tier1aQuestions.forEach((q, i) => {
            const myAnswer = Array.isArray(myTier1a) ? myTier1a[i]?.value || myTier1a[i] : myTier1a[i];
            const theirAnswer = Array.isArray(theirTier1a) ? theirTier1a[i]?.value || theirTier1a[i] : theirTier1a[i];
            html += `
              <details><summary><strong>${q}</strong></summary>
              <p><strong>You:</strong> ${myAnswer || '<em>No answer</em>'}</p>
              <p><strong>Your Match:</strong> ${theirAnswer || '<em>No answer</em>'}</p>
              </details>`;
          });

          html += '<h3>üìò Tier 1b Answers</h3>';
          const myTier1b = tier1bData[currentUserId]?.answers || [];
          const theirTier1b = tier1bData[partnerUID]?.answers || [];

          tier1bQuestions.forEach((q, i) => {
            const myAnswer = myTier1b[i]?.value || myTier1b[i] || '<em>No answer</em>';
            const theirAnswer = theirTier1b[i]?.value || theirTier1b[i] || '<em>No answer</em>';
            html += `
              <details><summary><strong>${q}</strong></summary>
              <p><strong>You:</strong> ${myAnswer}</p>
              <p><strong>Your Match:</strong> ${theirAnswer}</p>
              </details>`;
          });

          html += '<h3>üìò Tier 2 Answers</h3>';
          const myTier2 = tier2Data[currentUserId]?.answers || [];
          const theirTier2 = tier2Data[partnerUID]?.answers || [];

          tier2Questions.forEach((q, i) => {
            html += `
              <details><summary><strong>${q}</strong></summary>
              <p><strong>You:</strong> ${myTier2[i] || '<em>No answer</em>'}</p>
              <p><strong>Your Match:</strong> ${theirTier2[i] || '<em>No answer</em>'}</p>
              </details>`;
          });

          storyContent.innerHTML = replaceEmojiWithMonochrome(html);
        } catch (err) {
          storyContent.innerHTML = '<p style="color:red;">Error loading story.</p>';
          console.error(err);
        }
      };

      closeBtn.onclick = () => {
        modal.style.display = 'none';
      };
    }
  </script>
</body>
</html>