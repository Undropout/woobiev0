import{o as ae,g as A,r as M,d as b,j as se,k as ce,l as le,m as re,p as G,n as ie,a as J,s as me}from"./firebase-config-CQBF9bbN.js";import"./logout-BHqC0Y9t.js";import"./feedback-CLnNHjql.js";ae(J,async s=>{if(!s){alert("You must be logged in to participate. Redirecting to login."),window.location.href="/auth/login.html";return}const c=s.uid,d=(await A(M(b,`users/${c}/currentMatch`))).val();if(console.log("[Chat] currentMatch data from database:",d),!d||!d.matchID||!d.username){console.error("[Chat] Missing matchID or username in currentMatch:",d),alert("You must complete matching before entering chat."),window.location.href="/name-picker/index.html";return}const r=d.matchID,y=d.username;console.log("[Chat] Initialized with matchID:",r,"username:",y);const v=M(b,`matches/${r}/chat`),x=localStorage.getItem("woobieMode")||"normal",f=document.getElementById("image-upload"),i=document.getElementById("chat-preview-canvas"),C=document.getElementById("chat-contrast"),P=document.getElementById("output-black"),W=document.getElementById("output-white"),j=document.getElementById("chat-image-alt"),Q=document.querySelectorAll(".color-btn"),H=document.getElementById("image-adjust-modal"),V=[document.getElementById("chat-cancel-upload"),...document.querySelectorAll(".close-adjust")],X=document.getElementById("chat-send-upload"),w=document.getElementById("message"),R=document.getElementById("messages"),O=document.getElementById("send-btn"),z=document.getElementById("image-modal"),D=document.getElementById("modal-img"),Y=document.getElementById("history-btn"),$=document.getElementById("history-modal"),T=document.getElementById("history-content"),K=document.getElementById("close-history");let I=null;i&&(I=i.getContext("2d",{willReadFrequently:!0}));let L=null,Z="#33ff33";const S={};S[y]=x;function F(e){return e.replace(new RegExp("(\\p{Emoji_Presentation}|\\p{Emoji}\\uFE0F)","gu"),t=>`<span class="woobie-emoji">${t}</span>`)}try{console.log("Checking user token claims...");let e=await s.getIdTokenResult(!1);if(console.log("Current token claims:",e.claims),console.log("Current match access:",e.claims.matchAccess),(!e.claims.matchAccess||!e.claims.matchAccess.includes(r))&&(console.log("Match access missing or incomplete. Forcing token refresh..."),e=await s.getIdTokenResult(!0),console.log("Refreshed token claims:",e.claims),console.log("Refreshed match access:",e.claims.matchAccess)),console.log("Does user have access to this match?",e.claims.matchAccess&&e.claims.matchAccess.includes(r)),!e.claims.matchAccess||!e.claims.matchAccess.includes(r)){console.error("User still lacks access to match after token refresh. Backend issue?"),alert("Authentication issue. Please try refreshing the page or logging out and back in.");return}}catch(e){console.error("Error getting ID token:",e),alert("Authentication error. Please try refreshing the page.");return}A(M(b,`matches/${r}/modes`)).then(e=>(e.val(),A(M(b,`matches/${r}/users`)))).then(e=>{const t=e.val()||{};return A(M(b,`matches/${r}/modes`)).then(o=>{const n=o.val()||{};for(const[a,m]of Object.entries(t))n[a]&&n[a].mode&&(S[m]=n[a].mode,console.log(`Set mode for ${m}: ${n[a].mode}`));console.log("Final modeMap:",S)})}).catch(e=>{console.error("Error loading modes:",e)});function ee(e){for(let t=0;t<3;t++){const o=document.createElement("span");o.className="trail-sparkle",o.textContent="âœ¨",o.style.position="absolute",o.style.top=`${Math.random()*100-30}%`,o.style.left=`${Math.random()*100-30}%`,o.style.animationDelay=`${Math.random()*2}s`,o.innerHTML=F(o.textContent),e.appendChild(o)}}Q.forEach(e=>{e.onclick=()=>{Z=e.dataset.color,q()}}),[C,P,W].forEach(e=>{e.oninput=q}),f.onchange=e=>{const t=e.target.files[0];if(!t)return;const o=new FileReader;o.onload=n=>{const a=new Image;a.onload=()=>{const u=128/Math.max(a.width,a.height),l=Math.round(a.width*u),B=Math.round(a.height*u),E=document.createElement("canvas");E.width=l,E.height=B,E.getContext("2d").drawImage(a,0,0,l,B);const h=new Image;h.onload=()=>{L=h,i.width=l*4,i.height=B*4,I.drawImage(L,0,0,i.width,i.height),H.style.display="block",q()},h.src=E.toDataURL()},a.src=n.target.result},o.readAsDataURL(t)},X.onclick=()=>{const e=j.value.trim();if(!e)return alert("Please add alt text");const t=document.createElement("canvas");t.width=i.width,t.height=i.height;const o=t.getContext("2d");o.imageSmoothingEnabled=!1,o.drawImage(i,0,0),t.toBlob(async n=>{try{await s.getIdToken(!0),console.log("Token refreshed before upload"),console.log("Blob size:",n.size,"bytes"),console.log("Blob type:",n.type),console.log("Size limit check (512KB):",n.size<512*1024,"(should be true)");const a=`${Date.now()}.png`,m=`chat/${r}/${a}`;console.log("Uploading to path:",m),console.log("Current user ID:",c),console.log("Match ID:",r);const u=se(ce,m);await le(u,n);const l=await re(u);G(v,{senderUID:c,sender:y,format:"image",url:l,alt:e,timestamp:Date.now()}),H.style.display="none",j.value="",f.value=""}catch(a){console.error("Image upload failed:",a),alert("Failed to upload image. Please try again.")}},"image/png")};function q(){if(!L||!I)return;const{width:e,height:t}=i;I.drawImage(L,0,0,e,t);const o=I.getImageData(0,0,e,t),n=o.data,a=+C.value,m=+P.value,u=+W.value,{r:l,g:B,b:E}=te(Z);for(let g=0;g<n.length;g+=4){let h=.2126*n[g]+.7152*n[g+1]+.0722*n[g+2];h=(h-128)*(a/100+1)+128,h=Math.max(0,Math.min(255,h));const ne=(h-0)/255*(u-m)+m;let U=Math.floor(ne/64);U=Math.max(0,Math.min(3,U));const N=[0,85,170,255][U];n[g]=N/255*l,n[g+1]=N/255*B,n[g+2]=N/255*E}I.putImageData(o,0,0)}function te(e){const t=parseInt(e.slice(1),16);return{r:t>>16&255,g:t>>8&255,b:t&255}}function oe(e){D.src=e.src,D.alt=e.alt||"",D.style.maxWidth="384px",D.style.maxHeight="384px",z.style.display="flex",z.onclick=()=>{z.style.display="none"}}window.insertEmote=e=>{w.value+=e,w.focus()},O&&w&&(O.onclick=_,w.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),_())}));function _(){const e=w.value.trim();e&&(G(v,{senderUID:c,sender:y,format:"text",value:e,timestamp:Date.now()}),w.value="")}ie(v,e=>{const t=e.val(),o=document.createElement("div");o.className="message";const n=new Date(t.timestamp).toLocaleString(),a=t.sender,m=S[a]||"normal",u=`woobie-${m}`;if(t.format==="text"){const l=F(t.value);o.innerHTML=`<strong class="${u}">${a}</strong> [${n}]: ${l}`}else if(t.format==="image"){F(t.alt),o.innerHTML=`<strong class="${u}">${a}</strong> [${n}]:<br><img src="${t.url}" alt="${t.alt}" class="chat-img" style="cursor: zoom-in; max-width:128px; height:auto;" />`;const l=o.querySelector("img");l.onclick=()=>oe(l)}if(R.appendChild(o),R.scrollTop=R.scrollHeight,m==="cosmic"){const l=o.querySelector(`.${u}`);l&&ee(l)}}),Y&&$&&K&&($.style.display="none",Y.onclick=async()=>{$.style.display="flex",T.innerHTML='<div style="color:#33ff33;font-family:monospace"><h3>Loading full history...</h3></div>';try{const e=document.createElement("iframe");e.src="/shared/history.html",e.style.width="100%",e.style.height="80vh",e.style.border="1px solid #33ff33",e.style.backgroundColor="black",T.innerHTML="",T.appendChild(e)}catch(e){console.error(e),T.innerHTML="<p>Error loading history.</p>"}},K.onclick=()=>{$.style.display="none"}),V.forEach(e=>{e&&(e.onclick=()=>{H.style.display="none",j.value="",f.value=""})})});function p(s){return s.replace(new RegExp("(\\p{Emoji_Presentation}|\\p{Emoji}\\uFE0F)","gu"),c=>`<span class="woobie-emoji">${c}</span>`)}document.addEventListener("DOMContentLoaded",()=>{const s=document.getElementById("logout-button");s&&(s.innerHTML=p(s.textContent));const c=document.getElementById("history-btn");c&&(c.innerHTML=p(c.textContent));const k=document.getElementById("send-btn");k&&(k.innerHTML=p(k.textContent));const d=document.querySelector(".woobie-upload-label");d&&(d.innerHTML=p(d.textContent));const r=document.querySelector("#image-adjust-modal h2");r&&(r.innerHTML=p(r.textContent));const y=document.getElementById("chat-send-upload");y&&(y.innerHTML=p(y.textContent)),document.querySelectorAll("#emoji-bar button").forEach(x=>{const f=x.getAttribute("onclick");if(f){const i=f.match(/insertEmote\('([^']+)'\)/);if(i){const C=i[1];x.innerHTML=p(C)}}})});const de=document.getElementById("logout-button");de.onclick=async()=>{if(confirm("Are you sure you want to log out? You'll lose your place unless you're logged in.")){try{await me(J)}catch(c){console.warn("Firebase sign-out failed:",c)}localStorage.clear(),sessionStorage.clear(),window.location.href="/resume.html"}};setTimeout(()=>{const s=document.getElementById("feedback-btn");if(s){s.style.position="static",s.style.display="block",s.style.margin="1rem auto 0",s.style.opacity="1";const c=document.querySelector(".woobie-upload-section");c&&s.parentNode!==c.parentNode&&c.parentNode.insertBefore(s,c.nextSibling)}},100);
