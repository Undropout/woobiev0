import{o as oe,r as u,d,u as D,a as ne,g as M,b as p,c as q,e as b}from"./firebase-config-DqIMhm9h.js";/* empty css              */import"./logout-C5vuDOMp.js";function le(e){return e.replace(new RegExp("(\\p{Emoji_Presentation}|\\p{Emoji}\\uFE0F)","gu"),s=>`<span class="woobie-emoji">${s}</span>`)}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("logout-button");e.innerHTML=le(e.textContent);const s=document.getElementById("submit-btn");s.innerHTML='Next <span class="woobie-emoji">â†’</span>'});window.addEventListener("tier1bComplete",()=>{oe(ne,async e=>{if(!e)return;console.log("tier1bComplete event triggered, updating stage for user:",e.uid);const s=u(d,`users/${e.uid}/currentMatch`);await D(s,{stage:"tier1b-complete"})})});function F(e){return e.replace(new RegExp("(\\p{Emoji_Presentation}|\\p{Emoji}\\uFE0F)","gu"),s=>`<span class="woobie-emoji">${s}</span>`)}const x=["What's something you're working on improving?","How do you recharge after a stressful day?","What's a non-negotiable value in your life?","What do you want more of in your future?","What makes you feel heard?","What's a memory you'd share to explain who you are?"];let k=[],g=0;const N=document.getElementById("question-block"),Z=document.getElementById("question-number"),U=document.getElementById("question-text"),C=document.getElementById("answer"),ee=document.getElementById("submit-btn"),w=document.getElementById("completion-message"),se=document.getElementById("tier1b-review");se.parentElement&&document.getElementById("tier1b-review-wrapper")&&document.getElementById("tier1b-review-wrapper").remove();const T=document.createElement("div");T.id="tier1b-review-wrapper";se.appendChild(T);oe(ne,e=>{if(!e){alert("You must be logged in to continue. Redirecting to login..."),window.location.href="/auth/login.html";return}const s=e.uid;let f=localStorage.getItem("woobieMatchID"),v=localStorage.getItem("woobieUsername");if(!f||!v){M(u(d,`users/${s}/currentMatch`)).then($=>{const l=$.val();if(!l||!l.matchID||!l.username){alert("No match found. Please restart."),window.location.href="/name-picker/index.html";return}f=l.matchID,v=l.username,localStorage.setItem("woobieMatchID",f),localStorage.setItem("woobieUsername",v),te(s,f,v)}).catch($=>{console.error("Error fetching match data:",$),alert("Error loading session. Please try again.")});return}te(s,f,v)});async function te(e,s,f){console.log(`[Tier1b INIT] MatchID: ${s}, UserID: ${e}, WoobieName: ${f}`);const v=u(d,`users/${e}/currentMatch`);D(v,{stage:"tier1b"}),p(u(d,`matches/${s}/meta/${e}`),{stage:"tier1b",joinedAt:Date.now(),woobieName:f});const $=u(d,`matches/${s}/tier1b/${e}`),l=u(d,`matches/${s}/tier1b`),V=u(d,`matches/${s}/tier1bLetters/${e}`),I=u(d,`matches/${s}/tier1bLetters`),Q=u(d,`matches/${s}/tier1bVotes/${e}`),W=u(d,`matches/${s}/tier1bVotes`);let E=null,B=null,S=null;function _(){E&&b(l,"value",E),B&&b(I,"value",B),S&&b(W,"value",S)}window.addEventListener("beforeunload",_);try{if((await M($)).exists()){console.log("[Tier1b] User has already submitted answers, skipping to review"),N&&(N.style.display="none"),w&&(w.style.display="block");const r=(await M(l)).val();if(r&&Object.keys(r).length>=2){const a=Object.keys(r).find(y=>y!==e);a&&r[e]&&r[a]?(console.log("[Tier1b] Both answers exist, showing review immediately"),w.style.display="none",G(r[e],r[a])):H()}else H();return}}catch(t){console.error("Error checking existing answers:",t)}const O=u(d,`matches/${s}/tier1bDrafts/${e}`);try{const t=await M(O);if(t.exists()){const o=t.val();k=o.answers||[],g=o.currentIndex||0,console.log("[Tier1b] Loaded partial draft from database:",{answerCount:k.length,currentIndex:g})}else console.log("[Tier1b] No draft found in database, starting fresh")}catch(t){console.error("Error loading tier1b draft from database:",t)}function re(){const t={answers:k,currentIndex:g,lastSaved:Date.now()};p(O,t).then(()=>{console.log("[Tier1b] Saved draft to database:",{answerCount:k.length,currentIndex:g})}).catch(o=>{console.error("[Tier1b] Error saving draft to database:",o)})}function z(){var t;if(g>=x.length){N&&(N.style.display="none"),w&&(w.style.display="block"),p($,{answers:k,woobieName:f}).then(()=>(console.log("Tier1b answers submitted for user:",e),p(O,null))).then(()=>{console.log("Tier1b draft cleared from database")}).catch(o=>console.error("Error saving tier1b answers:",o)),H();return}Z&&(Z.textContent=`Question ${g+1} of ${x.length}`),U&&(U.textContent=x[g]),C&&(C.value=((t=k[g])==null?void 0:t.value)||"")}ee&&(ee.onclick=()=>{if(!C)return;const t=C.value.trim();t&&(k[g]={question:x[g],value:t,format:"text"},g++,re(),z())});function H(){console.log("[waitForBothAnswers] Setting listener on:",l.toString()),E&&b(l,"value",E),E=q(l,async t=>{const o=t.val();if(console.log("[waitForBothAnswers] All answers data:",o),!o||Object.keys(o).length<2){w&&(w.style.display="block");return}const r=Object.keys(o).find(a=>a!==e);if(!r||!o[e]||!o[r]){w&&(w.style.display="block");return}w&&(w.style.display="none"),await G(o[e],o[r]),b(l,"value",E),E=null},t=>{console.error("Error in waitForBothAnswers listener:",t)})}function A(){console.log("[attachVoteHandlers] Attaching vote button click handlers"),document.getElementById("vote-yes").onclick=()=>{console.log("[vote-yes] Voted YES for user:",e),p(Q,!0).then(J).catch(t=>console.error("Error voting yes:",t))},document.getElementById("vote-no").onclick=()=>{console.log("[vote-no] Voted NO for user:",e);const t=prompt("If you're sure you want to end the match, type 'Goodbye' to confirm.");(t==null?void 0:t.trim().toLowerCase())==="goodbye"&&p(Q,!1).then(J).catch(o=>console.error("Error voting no:",o))}}async function G(t,o){var K,X;console.log("[showReviewUI] Showing Q&A and letter UI");const r=t.woobieName||f||"You",a=o.woobieName||"Your Match";T.innerHTML=F("<h2>ğŸ“˜ Review Answers</h2>");for(let i=0;i<x.length;i++)T.innerHTML+=`
        <details><summary><strong>${x[i]}</strong></summary>
        <p><strong>${r}:</strong> ${((K=t.answers[i])==null?void 0:K.value)||"<em>No answer</em>"}</p>
        <p><strong>${a}:</strong> ${((X=o.answers[i])==null?void 0:X.value)||"<em>No answer</em>"}</p>
        </details>`;const L=(await M(V)).exists();console.log("[showReviewUI] Letter already submitted?",L);const m=`
      <h2>ğŸ’Œ Send a Message (Optional)</h2>
      <textarea id="letter-input" rows="6" placeholder="Max 250 words..."></textarea>
      <p id="letter-count">0 / 250 words</p>
      <p id="letter-message" style="color:#ff6666;"></p>
      <button id="submit-letter" class="woobie-button">Send â†’</button>
      <button id="skip-letter" class="woobie-button">Skip</button>
      <div id="letter-review" style="margin-top:2rem;"></div>
      <div id="vote-section" style="display:none;">
        <h2>Do you want to continue to Tier 2?</h2>
        <button id="vote-yes" class="woobie-button">ğŸ‘ Yes</button>
        <button id="vote-no" class="woobie-button">ğŸ‘ No</button>
        <p id="vote-waiting" style="display:none;">Waiting for your match's vote...</p>
      </div>
    `;T.innerHTML+=F(m);const n=document.getElementById("letter-input"),c=document.getElementById("letter-count"),h=document.getElementById("letter-message"),R=document.getElementById("letter-review"),P=document.getElementById("vote-section");if(L){console.log("[showReviewUI] Letter already submitted, skipping input UI");const i=document.getElementById("submit-letter"),j=document.getElementById("skip-letter");i&&(i.style.display="none"),j&&(j.style.display="none"),n&&(n.style.display="none"),c&&(c.style.display="none"),A(),await Y(R,P,r,a);return}n&&(n.oninput=()=>{const i=n.value.trim().split(/\s+/).filter(Boolean);c&&(c.textContent=`${i.length} / 250 words`)}),document.getElementById("submit-letter").onclick=()=>{if(!n||!h)return;const i=n.value.trim(),j=i.split(/\s+/).filter(Boolean),ie=/(.)\1{20,}/.test(i);if(j.length>250||ie){h.textContent="Please keep your message under 250 words and avoid excessive repeated characters.";return}h.textContent="",console.log("[submit-letter] Submitting letter:",i),p(V,i).then(()=>(A(),Y(R,P,t.woobieName,o.woobieName))).catch(ae=>console.error("Error submitting letter:",ae))},document.getElementById("skip-letter").onclick=()=>{console.log("[skip-letter] Skipping letter."),p(V,"").then(()=>(A(),Y(R,P,t.woobieName,o.woobieName))).catch(i=>console.error("Error skipping letter:",i))},A()}async function Y(t,o,r,a){console.log("[waitForLetterReview] Checking for both letters...");const y=document.getElementById("submit-letter"),L=document.getElementById("skip-letter");y&&(y.style.display="none"),L&&(L.style.display="none");try{const n=(await M(I)).val();if(console.log("[waitForLetterReview] Initial check - letters:",n),n&&Object.keys(n).length>=2){const c=Object.keys(n).find(h=>h!==e);if(c&&n[c]!==void 0&&n[e]!==void 0){console.log("[waitForLetterReview] Both letters already exist, showing review");const h=`
            <h3>ğŸ’Œ Direct Messages</h3>
            <details open><summary>What ${r} wrote</summary><p>${n[e]||"(You chose not to send a message.)"}</p></details>
            <details open><summary>What ${a} wrote</summary><p>${n[c]||"(Your match chose not to send a message.)"}</p></details>
          `;t.innerHTML=F(h),o.style.display="block";return}}}catch(m){console.error("[waitForLetterReview] Error checking letters:",m)}console.log("[waitForLetterReview] Waiting for partner's letter..."),B&&b(I,"value",B),B=q(I,m=>{const n=m.val();if(console.log("[waitForLetterReview] Listener fired - letters:",n),!n||Object.keys(n).length<2)return;const c=Object.keys(n).find(R=>R!==e);if(!c||n[c]===void 0||n[e]===void 0)return;const h=`
        <h3>ğŸ’Œ Direct Messages</h3>
        <details open><summary>What ${r} wrote</summary><p>${n[e]||"(You chose not to send a message.)"}</p></details>
        <details open><summary>What ${a} wrote</summary><p>${n[c]||"(Your match chose not to send a message.)"}</p></details>
      `;t.innerHTML=F(h),o.style.display="block",b(I,"value",B),B=null},m=>{console.error("Error in waitForLetterReview listener:",m)})}function J(){console.log("[waitForMutualVote] Waiting for both votes...");const t=document.getElementById("vote-yes"),o=document.getElementById("vote-no"),r=document.getElementById("vote-waiting");t&&(t.style.display="none"),o&&(o.style.display="none"),r&&(r.style.display="block"),S&&b(W,"value",S),S=q(W,a=>{const y=a.val();if(console.log("[waitForMutualVote] votes:",y),!y||Object.keys(y).length<2)return;_();const L=Object.values(y).every(n=>n===!0),m=u(d,`users/${e}/currentMatch`);L?(D(m,{stage:"tier2"}),window.location.href="/tier2/index.html"):(D(m,{stage:"goodbye-tier1b"}),window.location.href="/goodbye.html")},a=>{console.error("Error in waitForMutualVote listener:",a)})}z()}
