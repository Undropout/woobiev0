import{o as se,r as l,d as c,u as C,a as re,g as I,b,c as Q,e as v}from"./firebase-config-DqIMhm9h.js";/* empty css              */import"./logout-C5vuDOMp.js";function ue(t){return t.replace(new RegExp("(\\p{Emoji_Presentation}|\\p{Emoji}\\uFE0F)","gu"),s=>`<span class="woobie-emoji">${s}</span>`)}document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("logout-button");t.innerHTML=ue(t.textContent);const s=document.getElementById("submit-btn");s.innerHTML='Next <span class="woobie-emoji">→</span>'});window.addEventListener("tier1bComplete",()=>{se(re,async t=>{if(!t)return;console.log("tier1bComplete event triggered, updating stage for user:",t.uid);const s=l(c,`users/${t.uid}/currentMatch`);await C(s,{stage:"tier1b-complete"})})});function F(t){return t.replace(new RegExp("(\\p{Emoji_Presentation}|\\p{Emoji}\\uFE0F)","gu"),s=>`<span class="woobie-emoji">${s}</span>`)}const U=["If you could invite anyone in history to dinner, who would you choose and why?","Would you ever want to be famous? If yes, what would you want to be known for?","Do you rehearse conversations before you have them? Why or why not?","Describe your 'perfect' day.","When did you last sing to yourself or to someone else?","If you could have one extraordinary skill or quality tomorrow, what would it be and why?","What's a secret hunch you have about your future?","What are you deeply grateful for right now?","If you could change something about your upbringing, what would it be?","Share a memory from your childhood that shaped who you are today.","What's something important about you that people often misunderstand, that you'd like a future friend to know?","If you could live to age 90, would you rather retain the mind or body of a 30-year-old for your final 60 years?","If you could live in any fictional world, which would you choose and why?","If you could instantly master a musical instrument, which would it be?","If animals could talk, which one do you think you'd get along with best?","What era in history do you admire most in someone you love?","What makes you feel seen?","What's the most generous thing someone has done for you?","How do you show someone you care?","What's your go-to movie or show when you need a pick-me-up?","Do you prefer sunrise or sunset?","What do you do when you want to feel cozy?","Do you believe people are inherently good?","If happiness were a place, what would it look like?","What do you think is humanity's greatest strength?","What's your dream vacation destination—and what would you do there?","What's your most chaotic or impulsive story?","What's a strength of yours that others overlook?","Do you forgive yourself easily?","What kind of environments help you thrive?","What helps you bounce back after a hard day?"];let f=[],$=[],m=0;const N=document.getElementById("question-block"),ee=document.getElementById("question-number"),te=document.getElementById("question-text"),D=document.getElementById("answer"),oe=document.getElementById("submit-btn"),h=document.getElementById("completion-message"),ie=document.getElementById("tier1b-review");ie.parentElement&&document.getElementById("tier1b-review-wrapper")&&document.getElementById("tier1b-review-wrapper").remove();const W=document.createElement("div");W.id="tier1b-review-wrapper";ie.appendChild(W);se(re,t=>{if(!t){alert("You must be logged in to continue. Redirecting to login..."),window.location.href="/auth/login.html";return}const s=t.uid;let y=localStorage.getItem("woobieMatchID"),k=localStorage.getItem("woobieUsername");if(!y||!k){I(l(c,`users/${s}/currentMatch`)).then(M=>{const p=M.val();if(!p||!p.matchID||!p.username){alert("No match found. Please restart."),window.location.href="/name-picker/index.html";return}y=p.matchID,k=p.username,localStorage.setItem("woobieMatchID",y),localStorage.setItem("woobieUsername",k),ne(s,y,k)}).catch(M=>{console.error("Error fetching match data:",M),alert("Error loading session. Please try again.")});return}ne(s,y,k)});async function ne(t,s,y){console.log(`[Tier1b INIT] MatchID: ${s}, UserID: ${t}, WoobieName: ${y}`);const k=l(c,`matches/${s}/tier1Questions`);try{const e=await I(k);e.exists()?(f=e.val().slice(6,12),console.log("Loaded randomized questions for tier1b from match:",s)):(f=U.slice(6,12),console.warn("tier1Questions not found in database, using fallback questions"))}catch(e){console.error("Error loading questions:",e),f=U.slice(6,12)}const M=l(c,`users/${t}/currentMatch`);C(M,{stage:"tier1b"}),b(l(c,`matches/${s}/meta/${t}`),{stage:"tier1b",joinedAt:Date.now(),woobieName:y});const p=l(c,`matches/${s}/tier1b/${t}`),x=l(c,`matches/${s}/tier1b`),V=l(c,`matches/${s}/tier1bLetters/${t}`),S=l(c,`matches/${s}/tier1bLetters`),z=l(c,`matches/${s}/tier1bVotes/${t}`),q=l(c,`matches/${s}/tier1bVotes`);let E=null,B=null,R=null;function _(){E&&v(x,"value",E),B&&v(S,"value",B),R&&v(q,"value",R)}window.addEventListener("beforeunload",_);try{if((await I(p)).exists()){console.log("[Tier1b] User has already submitted answers, skipping to review"),N&&(N.style.display="none"),h&&(h.style.display="block");const r=(await I(x)).val();if(r&&Object.keys(r).length>=2){const a=Object.keys(r).find(w=>w!==t);a&&r[t]&&r[a]?(console.log("[Tier1b] Both answers exist, showing review immediately"),h.style.display="none",J(r[t],r[a])):H()}else H();return}}catch(e){console.error("Error checking existing answers:",e)}const O=l(c,`matches/${s}/tier1bDrafts/${t}`);try{const e=await I(O);if(e.exists()){const o=e.val();$=o.answers||[],m=o.currentIndex||0,console.log("[Tier1b] Loaded partial draft from database:",{answerCount:$.length,currentIndex:m})}else console.log("[Tier1b] No draft found in database, starting fresh")}catch(e){console.error("Error loading tier1b draft from database:",e)}function ae(){const e={answers:$,currentIndex:m,lastSaved:Date.now()};b(O,e).then(()=>{console.log("[Tier1b] Saved draft to database:",{answerCount:$.length,currentIndex:m})}).catch(o=>{console.error("[Tier1b] Error saving draft to database:",o)})}function G(){var e;if(m>=f.length){N&&(N.style.display="none"),h&&(h.style.display="block"),b(p,{answers:$,woobieName:y}).then(()=>(console.log("Tier1b answers submitted for user:",t),b(O,null))).then(()=>{console.log("Tier1b draft cleared from database")}).catch(o=>console.error("Error saving tier1b answers:",o)),H();return}ee&&(ee.textContent=`Question ${m+1} of ${f.length}`),te&&(te.textContent=f[m]),D&&(D.value=((e=$[m])==null?void 0:e.value)||"")}oe&&(oe.onclick=()=>{if(!D)return;const e=D.value.trim();e&&($[m]={question:f[m],value:e,format:"text"},m++,ae(),G())});function H(){console.log("[waitForBothAnswers] Setting listener on:",x.toString()),E&&v(x,"value",E),E=Q(x,async e=>{const o=e.val();if(console.log("[waitForBothAnswers] All answers data:",o),!o||Object.keys(o).length<2){h&&(h.style.display="block");return}const r=Object.keys(o).find(a=>a!==t);if(!r||!o[t]||!o[r]){h&&(h.style.display="block");return}h&&(h.style.display="none"),await J(o[t],o[r]),v(x,"value",E),E=null},e=>{console.error("Error in waitForBothAnswers listener:",e)})}function A(){console.log("[attachVoteHandlers] Attaching vote button click handlers"),document.getElementById("vote-yes").onclick=()=>{console.log("[vote-yes] Voted YES for user:",t),b(z,!0).then(K).catch(e=>console.error("Error voting yes:",e))},document.getElementById("vote-no").onclick=()=>{console.log("[vote-no] Voted NO for user:",t);const e=prompt("If you're sure you want to end the match, type 'Goodbye' to confirm.");(e==null?void 0:e.trim().toLowerCase())==="goodbye"&&b(z,!1).then(K).catch(o=>console.error("Error voting no:",o))}}async function J(e,o){var X,Z;console.log("[showReviewUI] Showing Q&A and letter UI");const r=e.woobieName||y||"You",a=o.woobieName||"Your Match";W.innerHTML=F("<h2>📘 Review Answers</h2>");for(let i=0;i<f.length;i++)W.innerHTML+=`
        <details><summary><strong>${f[i]}</strong></summary>
        <p><strong>${r}:</strong> ${((X=e.answers[i])==null?void 0:X.value)||"<em>No answer</em>"}</p>
        <p><strong>${a}:</strong> ${((Z=o.answers[i])==null?void 0:Z.value)||"<em>No answer</em>"}</p>
        </details>`;const L=(await I(V)).exists();console.log("[showReviewUI] Letter already submitted?",L);const d=`
      <h2>💌 Send a Message (Optional)</h2>
      <textarea id="letter-input" rows="6" placeholder="Max 250 words..."></textarea>
      <p id="letter-count">0 / 250 words</p>
      <p id="letter-message" style="color:#ff6666;"></p>
      <button id="submit-letter" class="woobie-button">Send →</button>
      <button id="skip-letter" class="woobie-button">Skip</button>
      <div id="letter-review" style="margin-top:2rem;"></div>
      <div id="vote-section" style="display:none;">
        <h2>Do you want to continue to Tier 2?</h2>
        <button id="vote-yes" class="woobie-button">👍 Yes</button>
        <button id="vote-no" class="woobie-button">👎 No</button>
        <p id="vote-waiting" style="display:none;">Waiting for your match's vote...</p>
      </div>
    `;W.innerHTML+=F(d);const n=document.getElementById("letter-input"),u=document.getElementById("letter-count"),g=document.getElementById("letter-message"),T=document.getElementById("letter-review"),P=document.getElementById("vote-section");if(L){console.log("[showReviewUI] Letter already submitted, skipping input UI");const i=document.getElementById("submit-letter"),j=document.getElementById("skip-letter");i&&(i.style.display="none"),j&&(j.style.display="none"),n&&(n.style.display="none"),u&&(u.style.display="none"),A(),await Y(T,P,r,a);return}n&&(n.oninput=()=>{const i=n.value.trim().split(/\s+/).filter(Boolean);u&&(u.textContent=`${i.length} / 250 words`)}),document.getElementById("submit-letter").onclick=()=>{if(!n||!g)return;const i=n.value.trim(),j=i.split(/\s+/).filter(Boolean),le=/(.)\1{20,}/.test(i);if(j.length>250||le){g.textContent="Please keep your message under 250 words and avoid excessive repeated characters.";return}g.textContent="",console.log("[submit-letter] Submitting letter:",i),b(V,i).then(()=>(A(),Y(T,P,e.woobieName,o.woobieName))).catch(ce=>console.error("Error submitting letter:",ce))},document.getElementById("skip-letter").onclick=()=>{console.log("[skip-letter] Skipping letter."),b(V,"").then(()=>(A(),Y(T,P,e.woobieName,o.woobieName))).catch(i=>console.error("Error skipping letter:",i))},A()}async function Y(e,o,r,a){console.log("[waitForLetterReview] Checking for both letters...");const w=document.getElementById("submit-letter"),L=document.getElementById("skip-letter");w&&(w.style.display="none"),L&&(L.style.display="none");try{const n=(await I(S)).val();if(console.log("[waitForLetterReview] Initial check - letters:",n),n&&Object.keys(n).length>=2){const u=Object.keys(n).find(g=>g!==t);if(u&&n[u]!==void 0&&n[t]!==void 0){console.log("[waitForLetterReview] Both letters already exist, showing review");const g=`
            <h3>💌 Direct Messages</h3>
            <details open><summary>What ${r} wrote</summary><p>${n[t]||"(You chose not to send a message.)"}</p></details>
            <details open><summary>What ${a} wrote</summary><p>${n[u]||"(Your match chose not to send a message.)"}</p></details>
          `;e.innerHTML=F(g),o.style.display="block";return}}}catch(d){console.error("[waitForLetterReview] Error checking letters:",d)}console.log("[waitForLetterReview] Waiting for partner's letter..."),B&&v(S,"value",B),B=Q(S,d=>{const n=d.val();if(console.log("[waitForLetterReview] Listener fired - letters:",n),!n||Object.keys(n).length<2)return;const u=Object.keys(n).find(T=>T!==t);if(!u||n[u]===void 0||n[t]===void 0)return;const g=`
        <h3>💌 Direct Messages</h3>
        <details open><summary>What ${r} wrote</summary><p>${n[t]||"(You chose not to send a message.)"}</p></details>
        <details open><summary>What ${a} wrote</summary><p>${n[u]||"(Your match chose not to send a message.)"}</p></details>
      `;e.innerHTML=F(g),o.style.display="block",v(S,"value",B),B=null},d=>{console.error("Error in waitForLetterReview listener:",d)})}function K(){console.log("[waitForMutualVote] Waiting for both votes...");const e=document.getElementById("vote-yes"),o=document.getElementById("vote-no"),r=document.getElementById("vote-waiting");e&&(e.style.display="none"),o&&(o.style.display="none"),r&&(r.style.display="block"),R&&v(q,"value",R),R=Q(q,a=>{const w=a.val();if(console.log("[waitForMutualVote] votes:",w),!w||Object.keys(w).length<2)return;_();const L=Object.values(w).every(n=>n===!0),d=l(c,`users/${t}/currentMatch`);L?(C(d,{stage:"tier2"}),window.location.href="/tier2/index.html"):(C(d,{stage:"goodbye-tier1b"}),window.location.href="/goodbye.html")},a=>{console.error("Error in waitForMutualVote listener:",a)})}G()}
