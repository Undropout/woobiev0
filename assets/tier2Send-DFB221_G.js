import{q as $e,o as Te,r as l,d as i,u as re,j as ce,l as le,m as ie,b as w,g as te,c as ve,a as Se,e as De}from"./firebase-config-DqIMhm9h.js";/* empty css              */import"./logout-C5vuDOMp.js";function I(e){return e.replace(new RegExp("(\\p{Emoji_Presentation}|\\p{Emoji}\\uFE0F)","gu"),o=>`<span class="woobie-emoji">${o}</span>`)}document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("h1");e.innerHTML=I(e.textContent);const o=document.getElementById("logout-button");o.innerHTML=I(o.textContent),document.querySelectorAll("h3").forEach(L=>{L.innerHTML=I(L.textContent)});const a=document.getElementById("chat-send-upload");a.innerHTML='Send Image <span class="woobie-emoji">→</span>';const E=document.getElementById("submit-reward");E.innerHTML=I(E.textContent);const R=document.getElementById("close-story");R.innerHTML=I(R.textContent);const C=document.querySelector("#our-story-modal h2");C.innerHTML=I(C.textContent);const v=document.getElementById("our-story-button");v.innerHTML=I(v.textContent)});document.getElementById("image-upload").addEventListener("change",()=>{document.body.classList.add("has-image")});const de=document.getElementById("our-story-button"),me=document.getElementById("close-story"),S=document.getElementById("story-content"),X=document.getElementById("our-story-modal");de&&X&&S&&me&&(de.onclick=async()=>{X.style.display="block",S.innerHTML="<p>Loading...</p>";try{const e=document.createElement("iframe");e.src="/shared/history.html",e.style.width="100%",e.style.height="70vh",e.style.border="1px solid #33ff33",e.style.backgroundColor="black",S.innerHTML="",S.appendChild(e)}catch(e){console.error(e),S.innerHTML='<p style="color:red;">Error loading story.</p>'}},me.onclick=()=>{X.style.display="none"});const ue=$e();let f=null,D=null,ge="#33ff33",U=null,B=null,Z=[];Te(Se,async e=>{if(!e){alert("You must be logged in to participate. Redirecting to login."),window.location.href="/auth/login.html";return}const o=e.uid,a=localStorage.getItem("woobieMatchID"),E=localStorage.getItem("woobieUsername");if(!a||!E){alert("Missing critical session data (Match ID or Woobie Name). Please restart."),window.location.href="/name-picker/index.html";return}console.log(`[Tier2 Send INIT] MatchID: ${a}, UserID: ${o}, WoobieName: ${E}`);try{const t=await e.getIdTokenResult(!0);console.log("User custom claims:",t.claims),console.log("Match access claims:",t.claims.matchAccess),console.log("Does user have access to this match?",t.claims.matchAccess&&t.claims.matchAccess.includes(a))}catch(t){console.error("Error getting ID token:",t)}const R=l(i,`users/${o}/currentMatch`);re(R,{stage:"tier2-send"});const C=l(i,`matches/${a}/tier2Rewards/${o}`);l(i,`matches/${a}/tier2Votes/${o}`);const v=l(i,`matches/${a}/tier2Rewards`),L=document.getElementById("image-upload"),r=document.getElementById("chat-preview-canvas"),N=document.getElementById("chat-contrast"),V=document.getElementById("output-black"),z=document.getElementById("output-white"),Q=document.getElementById("chat-image-alt"),ne=document.querySelectorAll(".color-btn"),ae=document.getElementById("chat-send-upload"),Y=document.getElementById("reward-text"),b=document.getElementById("audio-preview"),m=document.getElementById("status-msg"),A=document.getElementById("start-recording"),H=document.getElementById("stop-recording"),W=document.getElementById("play-audio"),O=document.getElementById("reset-audio"),_=document.getElementById("recording-indicator"),se=document.getElementById("submit-reward");r&&(f=r.getContext("2d",{willReadFrequently:!0})),A&&H&&W&&O&&b&&_&&(A.onclick=async()=>{try{const t=await navigator.mediaDevices.getUserMedia({audio:!0});B=new MediaRecorder(t),Z=[],B.ondataavailable=n=>Z.push(n.data),B.onstop=()=>{U=new Blob(Z,{type:"audio/webm"}),b.src=URL.createObjectURL(U),b.style.display="block",W.disabled=!1,O.disabled=!1},B.start(),_.style.display="block",A.disabled=!0,H.disabled=!1}catch(t){console.error("Error accessing microphone:",t),alert("Could not access microphone. Please check your permissions.")}},H.onclick=()=>{B&&B.state==="recording"&&(B.stop(),_.style.display="none",A.disabled=!1,H.disabled=!0)},W.onclick=()=>{b.src&&b.play()},O.onclick=()=>{U=null,b.src="",b.style.display="none",W.disabled=!0,O.disabled=!0}),ne&&ne.forEach(t=>{t.onclick=()=>{ge=t.dataset.color,G()}}),[N,V,z].forEach(t=>{t&&(t.oninput=G)}),L&&(L.onchange=t=>{const n=t.target.files[0];if(!n)return;const c=new FileReader;c.onload=s=>{const u=new Image;u.onload=()=>{const g=128/Math.max(u.width,u.height),$=Math.round(u.width*g),T=Math.round(u.height*g),x=document.createElement("canvas");x.width=$,x.height=T,x.getContext("2d").drawImage(u,0,0,$,T);const y=new Image;y.onload=()=>{D=y,r&&f&&(r.width=$*4,r.height=T*4,f.drawImage(D,0,0,r.width,r.height),G())},y.src=x.toDataURL()},u.src=s.target.result},c.readAsDataURL(n)});function G(){if(!D||!f||!r)return;const{width:t,height:n}=r;f.drawImage(D,0,0,t,n);const c=f.getImageData(0,0,t,n),s=c.data,u=N?+N.value:0,k=V?+V.value:0,g=z?+z.value:255,{r:$,g:T,b:x}=Ce(ge);for(let h=0;h<s.length;h+=4){let y=.2126*s[h]+.7152*s[h+1]+.0722*s[h+2];y=(y-128)*(u/100+1)+128,y=Math.max(0,Math.min(255,y));const Le=(y-0)/255*(g-k)+k;let J=Math.floor(Le/64);J=Math.max(0,Math.min(3,J));const K=[0,85,170,255][J];s[h]=K/255*$,s[h+1]=K/255*T,s[h+2]=K/255*x}f.putImageData(c,0,0)}function Ce(t){const n=parseInt(t.slice(1),16);return{r:n>>16&255,g:n>>8&255,b:n&255}}if(ae&&(ae.onclick=()=>{m&&(m.textContent='Image ready. Click "Finalize & Send All" to complete submission.',m.style.color="#33ff33")}),se&&(se.onclick=async()=>{if(m){m.textContent="Uploading...",m.style.color="#33ff33";try{await e.getIdToken(!0),console.log("Token refreshed before upload");const t=[],n={text:(Y==null?void 0:Y.value.trim())||null,alt:(Q==null?void 0:Q.value.trim())||"",imageURL:null,audioURL:null,timestamp:Date.now(),woobieName:E};if(U){console.log(`Attempting to upload audio to: tier2/${a}/${o}-audio.webm`);const c=ce(ue,`tier2/${a}/${o}-audio.webm`);t.push(le(c,U).then(()=>ie(c).then(s=>n.audioURL=s)).catch(s=>{throw console.error("Audio upload failed:",s),s}))}if(D&&r&&f){console.log(`Attempting to upload image to: tier2/${a}/${o}-image.png`);const c=document.createElement("canvas");c.width=r.width,c.height=r.height,c.getContext("2d").drawImage(r,0,0);const u=await new Promise(g=>c.toBlob(g,"image/png")),k=ce(ue,`tier2/${a}/${o}-image.png`);t.push(le(k,u).then(()=>ie(k).then(g=>n.imageURL=g)).catch(g=>{throw console.error("Image upload failed:",g),g}))}console.log("Starting uploads..."),await Promise.all(t),console.log("All uploads completed successfully"),await w(C,n),await re(R,{stage:"tier2-reward-sent"}),m.textContent="✅ Reward sent! Redirecting...",m.style.color="#33ff33",setTimeout(()=>{window.location.href="/tier2/reveal.html"},2e3)}catch(t){console.error("Error submitting reward:",t),m&&(m.textContent=`❌ Error uploading: ${t.message}`,m.style.color="#ff6666")}}}),(await te(C)).exists()){console.log("[Tier2 Send] User has already submitted reward, checking if both ready...");const n=(await te(v)).val();if(n&&Object.keys(n).length>=2){console.log("[Tier2 Send] Both rewards exist, redirecting to reveal..."),window.location.href="/tier2/reveal.html";return}}ve(v,t=>{const n=t.val();console.log("[Tier2 Send] Rewards update:",n?Object.keys(n).length:0),n&&Object.keys(n).length>=2&&(console.log("[Tier2 Send] Both rewards detected, redirecting to reveal..."),De(v),window.location.href="/tier2/reveal.html")})});let d=localStorage.getItem("woobieMatchID"),p=localStorage.getItem("woobieUsername"),he=localStorage.getItem("woobieBio");d||(d=prompt("Missing match ID — please enter your match ID:"),localStorage.setItem("woobieMatchID",d));p||(p=prompt("Missing username — please enter your username:"),localStorage.setItem("woobieUsername",p));w(l(i,`matches/${d}/meta/${p}`),{stage:"tier1b",joinedAt:Date.now()});const Ue=l(i,`matches/${d}/tier1b/${p}`),qe=l(i,`matches/${d}/tier1b`),ke=l(i,`matches/${d}/tier1bLetters/${p}`);l(i,`matches/${d}/tier1bLetters`);const je=l(i,`matches/${d}/bios/${p}`);l(i,`matches/${d}/bios`);const xe=l(i,`matches/${d}/tier1bVotes/${p}`),Ae=l(i,`matches/${d}/tier1bVotes`),ee=["What's something you're working on improving?","How do you recharge after a stressful day?","What's a non-negotiable value in your life?","What do you want more of in your future?","What makes you feel heard?","What's a memory you'd share to explain who you are?"];let oe=[],M=0;const ye=document.getElementById("question-block"),fe=document.getElementById("question-number"),pe=document.getElementById("question-text"),q=document.getElementById("answer"),we=document.getElementById("submit-btn"),P=document.getElementById("completion-message"),F=document.getElementById("message-block"),j=document.getElementById("letter-input"),be=document.getElementById("letter-count"),Ie=document.getElementById("letter-message");function Me(){var e;if(M>=ee.length){ye&&(ye.style.display="none"),P&&(P.style.display="block"),w(Ue,oe),He();return}fe&&(fe.textContent=`Question ${M+1} of ${ee.length}`),pe&&(pe.textContent=ee[M]),q&&(q.value=((e=oe[M])==null?void 0:e.value)||"")}we&&(we.onclick=()=>{const e=q==null?void 0:q.value.trim();e&&(oe[M]={format:"text",value:e},M++,Me())});he&&w(je,he);function He(){te(qe).then(e=>{const o=e.val();o&&Object.keys(o).length>=2&&P&&F&&(P.style.display="none",F.style.display="block")})}j&&(j.oninput=()=>{const e=j.value.trim().split(/\s+/).filter(Boolean);be&&(be.textContent=`${e.length} / 250 words`)});const Be=document.getElementById("submit-letter");Be&&j&&Ie&&(Be.onclick=()=>{const e=j.value.trim(),o=e.split(/\s+/).filter(Boolean),a=/(.)\1{20,}/.test(e);if(o.length>250||a){Ie.textContent="Please keep your message under 250 words with no repeated spam characters.";return}w(ke,e),w(xe,!0),Re()});const Ee=document.getElementById("skip-letter");Ee&&(Ee.onclick=()=>{w(ke,""),w(xe,!0),Re()});function Re(){ve(Ae,e=>{const o=e.val();!o||Object.keys(o).length<2||(Object.values(o).every(a=>a===!0)?window.location.href="/tier2/index.html":F&&(F.innerHTML="<h2>Unfortunately, your match wasn't ready to continue. 😔</h2>"))})}Me();document.addEventListener("DOMContentLoaded",()=>{[document.querySelector('label[for="image-file"]'),document.querySelector('label[for="audio-file"]')].forEach(o=>{o&&o.addEventListener("click",()=>{o.classList.add("clicked"),setTimeout(()=>o.classList.remove("clicked"),200)})})});
