import{o as ae,g as S,r as M,d as v,j as se,k as ce,l as le,m as re,p as G,n as ie,a as J,s as me}from"./firebase-config-C0024qU1.js";import"./logout-q5yztgx1.js";ae(J,async r=>{if(!r){alert("You must be logged in to participate. Redirecting to login."),window.location.href="/auth/login.html";return}const i=r.uid,d=(await S(M(v,`users/${i}/currentMatch`))).val();if(console.log("[Chat] currentMatch data from database:",d),!d||!d.matchID||!d.username){console.error("[Chat] Missing matchID or username in currentMatch:",d),alert("You must complete matching before entering chat."),window.location.href="/name-picker/index.html";return}const c=d.matchID,y=d.username;console.log("[Chat] Initialized with matchID:",c,"username:",y);const x=M(v,`matches/${c}/chat`),C=localStorage.getItem("woobieMode")||"normal",p=document.getElementById("image-upload"),l=document.getElementById("chat-preview-canvas"),b=document.getElementById("chat-contrast"),W=document.getElementById("output-black"),N=document.getElementById("output-white"),j=document.getElementById("chat-image-alt"),Q=document.querySelectorAll(".color-btn"),H=document.getElementById("image-adjust-modal"),V=[document.getElementById("chat-cancel-upload"),...document.querySelectorAll(".close-adjust")],X=document.getElementById("chat-send-upload"),w=document.getElementById("message"),R=document.getElementById("messages"),O=document.getElementById("send-btn"),z=document.getElementById("image-modal"),D=document.getElementById("modal-img"),Y=document.getElementById("history-btn"),$=document.getElementById("history-modal"),T=document.getElementById("history-content"),K=document.getElementById("close-history");let I=null;l&&(I=l.getContext("2d",{willReadFrequently:!0}));let L=null,Z="#33ff33";const A={};A[y]=C;function F(e){return e.replace(new RegExp("(\\p{Emoji_Presentation}|\\p{Emoji}\\uFE0F)","gu"),t=>`<span class="woobie-emoji">${t}</span>`)}try{console.log("Checking user token claims...");let e=await r.getIdTokenResult(!1);if(console.log("Current token claims:",e.claims),console.log("Current match access:",e.claims.matchAccess),(!e.claims.matchAccess||!e.claims.matchAccess.includes(c))&&(console.log("Match access missing or incomplete. Forcing token refresh..."),e=await r.getIdTokenResult(!0),console.log("Refreshed token claims:",e.claims),console.log("Refreshed match access:",e.claims.matchAccess)),console.log("Does user have access to this match?",e.claims.matchAccess&&e.claims.matchAccess.includes(c)),!e.claims.matchAccess||!e.claims.matchAccess.includes(c)){console.error("User still lacks access to match after token refresh. Backend issue?"),alert("Authentication issue. Please try refreshing the page or logging out and back in.");return}}catch(e){console.error("Error getting ID token:",e),alert("Authentication error. Please try refreshing the page.");return}S(M(v,`matches/${c}/modes`)).then(e=>(e.val(),S(M(v,`matches/${c}/users`)))).then(e=>{const t=e.val()||{};return S(M(v,`matches/${c}/modes`)).then(o=>{const n=o.val()||{};for(const[a,m]of Object.entries(t))n[a]&&n[a].mode&&(A[m]=n[a].mode,console.log(`Set mode for ${m}: ${n[a].mode}`));console.log("Final modeMap:",A)})}).catch(e=>{console.error("Error loading modes:",e)});function ee(e){for(let t=0;t<3;t++){const o=document.createElement("span");o.className="trail-sparkle",o.textContent="âœ¨",o.style.position="absolute",o.style.top=`${Math.random()*100-30}%`,o.style.left=`${Math.random()*100-30}%`,o.style.animationDelay=`${Math.random()*2}s`,o.innerHTML=F(o.textContent),e.appendChild(o)}}Q.forEach(e=>{e.onclick=()=>{Z=e.dataset.color,U()}}),[b,W,N].forEach(e=>{e.oninput=U}),p.onchange=e=>{const t=e.target.files[0];if(!t)return;const o=new FileReader;o.onload=n=>{const a=new Image;a.onload=()=>{const u=128/Math.max(a.width,a.height),s=Math.round(a.width*u),B=Math.round(a.height*u),E=document.createElement("canvas");E.width=s,E.height=B,E.getContext("2d").drawImage(a,0,0,s,B);const h=new Image;h.onload=()=>{L=h,l.width=s*4,l.height=B*4,I.drawImage(L,0,0,l.width,l.height),H.style.display="block",U()},h.src=E.toDataURL()},a.src=n.target.result},o.readAsDataURL(t)},X.onclick=()=>{const e=j.value.trim();if(!e)return alert("Please add alt text");const t=document.createElement("canvas");t.width=l.width,t.height=l.height;const o=t.getContext("2d");o.imageSmoothingEnabled=!1,o.drawImage(l,0,0),t.toBlob(async n=>{try{await r.getIdToken(!0),console.log("Token refreshed before upload"),console.log("Blob size:",n.size,"bytes"),console.log("Blob type:",n.type),console.log("Size limit check (512KB):",n.size<512*1024,"(should be true)");const a=`${Date.now()}.png`,m=`chat/${c}/${a}`;console.log("Uploading to path:",m),console.log("Current user ID:",i),console.log("Match ID:",c);const u=se(ce,m);await le(u,n);const s=await re(u);G(x,{senderUID:i,sender:y,format:"image",url:s,alt:e,timestamp:Date.now()}),H.style.display="none",j.value="",p.value=""}catch(a){console.error("Image upload failed:",a),alert("Failed to upload image. Please try again.")}},"image/png")};function U(){if(!L||!I)return;const{width:e,height:t}=l;I.drawImage(L,0,0,e,t);const o=I.getImageData(0,0,e,t),n=o.data,a=+b.value,m=+W.value,u=+N.value,{r:s,g:B,b:E}=te(Z);for(let g=0;g<n.length;g+=4){let h=.2126*n[g]+.7152*n[g+1]+.0722*n[g+2];h=(h-128)*(a/100+1)+128,h=Math.max(0,Math.min(255,h));const ne=(h-0)/255*(u-m)+m;let q=Math.floor(ne/64);q=Math.max(0,Math.min(3,q));const P=[0,85,170,255][q];n[g]=P/255*s,n[g+1]=P/255*B,n[g+2]=P/255*E}I.putImageData(o,0,0)}function te(e){const t=parseInt(e.slice(1),16);return{r:t>>16&255,g:t>>8&255,b:t&255}}function oe(e){D.src=e.src,D.alt=e.alt||"",D.style.maxWidth="384px",D.style.maxHeight="384px",z.style.display="flex",z.onclick=()=>{z.style.display="none"}}window.insertEmote=e=>{w.value+=e,w.focus()},O&&w&&(O.onclick=_,w.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),_())}));function _(){const e=w.value.trim();e&&(G(x,{senderUID:i,sender:y,format:"text",value:e,timestamp:Date.now()}),w.value="")}ie(x,e=>{const t=e.val(),o=document.createElement("div");o.className="message";const n=new Date(t.timestamp).toLocaleString(),a=t.sender,m=A[a]||"normal",u=`woobie-${m}`;if(t.format==="text"){const s=F(t.value);o.innerHTML=`<strong class="${u}">${a}</strong> [${n}]: ${s}`}else if(t.format==="image"){F(t.alt),o.innerHTML=`<strong class="${u}">${a}</strong> [${n}]:<br><img src="${t.url}" alt="${t.alt}" class="chat-img" style="cursor: zoom-in; max-width:128px; height:auto;" />`;const s=o.querySelector("img");s.onclick=()=>oe(s)}if(R.appendChild(o),R.scrollTop=R.scrollHeight,m==="cosmic"){const s=o.querySelector(`.${u}`);s&&ee(s)}}),Y&&$&&K&&($.style.display="none",Y.onclick=async()=>{$.style.display="flex",T.innerHTML='<div style="color:#33ff33;font-family:monospace"><h3>Loading full history...</h3></div>';try{const e=document.createElement("iframe");e.src="/shared/history.html",e.style.width="100%",e.style.height="80vh",e.style.border="1px solid #33ff33",e.style.backgroundColor="black",T.innerHTML="",T.appendChild(e)}catch(e){console.error(e),T.innerHTML="<p>Error loading history.</p>"}},K.onclick=()=>{$.style.display="none"}),V.forEach(e=>{e&&(e.onclick=()=>{H.style.display="none",j.value="",p.value=""})})});function f(r){return r.replace(new RegExp("(\\p{Emoji_Presentation}|\\p{Emoji}\\uFE0F)","gu"),i=>`<span class="woobie-emoji">${i}</span>`)}document.addEventListener("DOMContentLoaded",()=>{const r=document.getElementById("logout-button");r&&(r.innerHTML=f(r.textContent));const i=document.getElementById("history-btn");i&&(i.innerHTML=f(i.textContent));const k=document.getElementById("send-btn");k&&(k.innerHTML=f(k.textContent));const d=document.querySelector(".woobie-upload-label");d&&(d.innerHTML=f(d.textContent));const c=document.querySelector("#image-adjust-modal h2");c&&(c.innerHTML=f(c.textContent));const y=document.getElementById("chat-send-upload");y&&(y.innerHTML=f(y.textContent)),document.querySelectorAll("#emoji-bar button").forEach(C=>{const p=C.getAttribute("onclick");if(p){const l=p.match(/insertEmote\('([^']+)'\)/);if(l){const b=l[1];C.innerHTML=f(b)}}})});const de=document.getElementById("logout-button");de.onclick=async()=>{if(confirm("Are you sure you want to log out? You'll lose your place unless you're logged in.")){try{await me(J)}catch(i){console.warn("Firebase sign-out failed:",i)}localStorage.clear(),sessionStorage.clear(),window.location.href="/resume.html"}};
