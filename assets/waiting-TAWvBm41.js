import{s as C,a as g,o as I,r as f,d as h,c as b,e as M,b as y,u as x}from"./firebase-config-DqIMhm9h.js";/* empty css              */function p(t){return t.replace(new RegExp("(\\p{Emoji_Presentation}|\\p{Emoji}\\uFE0F)","gu"),o=>`<span class="woobie-emoji">${o}</span>`)}document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelector("h1");t.innerHTML=p(t.textContent);const o=document.getElementById("logout-button");o&&(o.innerHTML=p(o.textContent))});const n=document.getElementById("statusMessage"),a=document.getElementById("matchIdDisplay"),d=document.getElementById("logout-button");let r=null,c=null,s=null;function w(){if(c&&r){const t=f(h,`users/${r}/currentMatch`);M(t,"value",c),console.log("Detached userCurrentMatchListener for user:",r),c=null}}d&&(d.onclick=async()=>{w();const t=r;if(t)try{await y(f(h,`/queue/${t}`),null),console.log(`User ${t} removed from queue due to logout/cancel.`),await x(f(h,`users/${t}/currentMatch`),{stage:"name-picker",matchID:null}),console.log(`User ${t} currentMatch stage reset.`)}catch(o){console.error("Error removing user from queue or resetting stage on logout:",o)}try{await C(g),console.log("User signed out from waiting page.")}catch(o){console.warn("Firebase sign-out failed on waiting page:",o)}localStorage.clear(),sessionStorage.clear(),window.location.href="/auth/login.html"});I(g,t=>{if(t){if(r=t.uid,s=localStorage.getItem("woobieMatchID"),d&&(d.style.display="inline-block"),a&&(s?a.textContent=s:(a.textContent="Waiting for match...",console.log("No initial matchID (likely referral code generator waiting for claimer)"))),!r){console.error("Critical error: User authenticated but UID is null on waiting page."),n&&(n.textContent="Authentication error. Please try logging in again."),setTimeout(()=>window.location.href="/auth/login.html",3e3);return}console.log(`Waiting page: User ${r} is logged in. Initial potential matchID from localStorage: ${s}`),n&&(n.textContent="Looking for a Woobie friend for you... Please wait.");const o=f(h,`users/${r}/currentMatch`);c&&(M(o,"value",c),c=null,console.log("Detached previous userCurrentMatchListener for user:",r)),c=b(o,async m=>{const u=m.val();if(u&&u.stage){console.log("Waiting page: Update received on user's currentMatch node:",u);const e=u.stage,l=u.matchID;if(e==="bio"||e.startsWith("tier")||e==="chatroom"){if(!l){console.error("Stage advanced but matchID missing!");return}console.log(`Match confirmed! Stage updated to '${e}'. Final Match ID: ${l}`),w();try{if(g.currentUser)await g.currentUser.getIdToken(!0),console.log("ID token refreshed, custom claims available for user:",r);else throw new Error("User session lost before token refresh on waiting page.")}catch(D){console.error("Error refreshing ID token for user:",r,D)}localStorage.setItem("woobieMatchID",l),a&&(a.textContent=`${l} (MATCHED!)`),n&&(n.textContent=`Match found! Proceeding to ${e}...`);let i="/bio/index.html";e==="bio"?i="/bio/index.html":e==="tier1a"?i="/tier1a/index.html":e==="tier1b"?i="/tier1b/index.html":e==="tier2"?i="/tier2/index.html":e==="tier2-complete"?i="/tier2/send.html":e==="tier2-reveal"?i="/tier2/reveal.html":e==="tier3"?i="/tier3/index.html":e==="chatroom"&&(i="/chat/index.html"),console.log(`Redirecting to: ${i}`),window.location.href=i}else e==="waiting_in_queue"?(console.log(`Still waiting. Current stage in DB: ${e}. MatchID: ${l||"none yet (waiting for referral claim)"}`),a&&(l?a.textContent=l:s?a.textContent=s:a.textContent="Waiting for match...")):console.log(`Current stage is '${e}'. Not yet 'bio' or later. MatchID: ${l||s||"none"}`)}else console.log("Waiting page: currentMatch data or stage is missing for user:",r,"(Snapshot data: ",u,")"),n&&(n.textContent="Waiting for session details to be fully initialized by the system...")},m=>{console.error("Error listening to user's currentMatch node on waiting page:",m),n&&(n.textContent="Error connecting. Please check connection or try again.")}),window.addEventListener("beforeunload",w)}else console.log("Waiting page: User not logged in, redirecting to login."),n&&(n.textContent="Not logged in. Redirecting..."),setTimeout(()=>{window.location.href="/auth/login.html"},2e3)});
