import{q as Re,o as De,r as l,d as i,u as ce,j as re,l as le,m as ie,b as f,c as ve,a as Te,e as Se,g as Ue}from"./firebase-config-DqIMhm9h.js";/* empty css              */import"./logout-C5vuDOMp.js";function I(e){return e.replace(new RegExp("(\\p{Emoji_Presentation}|\\p{Emoji}\\uFE0F)","gu"),o=>`<span class="woobie-emoji">${o}</span>`)}document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("h1");e.innerHTML=I(e.textContent);const o=document.getElementById("logout-button");o.innerHTML=I(o.textContent),document.querySelectorAll("h3").forEach(C=>{C.innerHTML=I(C.textContent)});const a=document.getElementById("chat-send-upload");a.innerHTML='Send Image <span class="woobie-emoji">→</span>';const E=document.getElementById("submit-reward");E.innerHTML=I(E.textContent);const x=document.getElementById("close-story");x.innerHTML=I(x.textContent);const q=document.querySelector("#our-story-modal h2");q.innerHTML=I(q.textContent);const A=document.getElementById("our-story-button");A.innerHTML=I(A.textContent)});document.getElementById("image-upload").addEventListener("change",()=>{document.body.classList.add("has-image")});const de=document.getElementById("our-story-button"),me=document.getElementById("close-story"),R=document.getElementById("story-content"),X=document.getElementById("our-story-modal");de&&X&&R&&me&&(de.onclick=async()=>{X.style.display="block",R.innerHTML="<p>Loading...</p>";try{const e=document.createElement("iframe");e.src="/shared/history.html",e.style.width="100%",e.style.height="70vh",e.style.border="1px solid #33ff33",e.style.backgroundColor="black",R.innerHTML="",R.appendChild(e)}catch(e){console.error(e),R.innerHTML='<p style="color:red;">Error loading story.</p>'}},me.onclick=()=>{X.style.display="none"});const ue=Re();let p=null,D=null,ge="#33ff33",T=null,B=null,Z=[];De(Te,async e=>{if(!e){alert("You must be logged in to participate. Redirecting to login."),window.location.href="/auth/login.html";return}const o=e.uid,a=localStorage.getItem("woobieMatchID"),E=localStorage.getItem("woobieUsername");if(!a||!E){alert("Missing critical session data (Match ID or Woobie Name). Please restart."),window.location.href="/name-picker/index.html";return}console.log(`[Tier2 Send INIT] MatchID: ${a}, UserID: ${o}, WoobieName: ${E}`);try{const t=await e.getIdTokenResult(!0);console.log("User custom claims:",t.claims),console.log("Match access claims:",t.claims.matchAccess),console.log("Does user have access to this match?",t.claims.matchAccess&&t.claims.matchAccess.includes(a))}catch(t){console.error("Error getting ID token:",t)}const x=l(i,`users/${o}/currentMatch`);ce(x,{stage:"tier2-send"});const q=l(i,`matches/${a}/tier2Rewards/${o}`),A=l(i,`matches/${a}/tier2Votes/${o}`),C=l(i,`matches/${a}/tier2Rewards`),oe=document.getElementById("image-upload"),c=document.getElementById("chat-preview-canvas"),N=document.getElementById("chat-contrast"),V=document.getElementById("output-black"),z=document.getElementById("output-white"),Q=document.getElementById("chat-image-alt"),ne=document.querySelectorAll(".color-btn"),ae=document.getElementById("chat-send-upload"),Y=document.getElementById("reward-text"),b=document.getElementById("audio-preview"),m=document.getElementById("status-msg"),H=document.getElementById("start-recording"),j=document.getElementById("stop-recording"),W=document.getElementById("play-audio"),P=document.getElementById("reset-audio"),_=document.getElementById("recording-indicator"),se=document.getElementById("submit-reward");c&&(p=c.getContext("2d",{willReadFrequently:!0})),H&&j&&W&&P&&b&&_&&(H.onclick=async()=>{try{const t=await navigator.mediaDevices.getUserMedia({audio:!0});B=new MediaRecorder(t),Z=[],B.ondataavailable=n=>Z.push(n.data),B.onstop=()=>{T=new Blob(Z,{type:"audio/webm"}),b.src=URL.createObjectURL(T),b.style.display="block",W.disabled=!1,P.disabled=!1},B.start(),_.style.display="block",H.disabled=!0,j.disabled=!1}catch(t){console.error("Error accessing microphone:",t),alert("Could not access microphone. Please check your permissions.")}},j.onclick=()=>{B&&B.state==="recording"&&(B.stop(),_.style.display="none",H.disabled=!1,j.disabled=!0)},W.onclick=()=>{b.src&&b.play()},P.onclick=()=>{T=null,b.src="",b.style.display="none",W.disabled=!0,P.disabled=!0}),ne&&ne.forEach(t=>{t.onclick=()=>{ge=t.dataset.color,G()}}),[N,V,z].forEach(t=>{t&&(t.oninput=G)}),oe&&(oe.onchange=t=>{const n=t.target.files[0];if(!n)return;const r=new FileReader;r.onload=s=>{const u=new Image;u.onload=()=>{const g=128/Math.max(u.width,u.height),L=Math.round(u.width*g),$=Math.round(u.height*g),k=document.createElement("canvas");k.width=L,k.height=$,k.getContext("2d").drawImage(u,0,0,L,$);const y=new Image;y.onload=()=>{D=y,c&&p&&(c.width=L*4,c.height=$*4,p.drawImage(D,0,0,c.width,c.height),G())},y.src=k.toDataURL()},u.src=s.target.result},r.readAsDataURL(n)});function G(){if(!D||!p||!c)return;const{width:t,height:n}=c;p.drawImage(D,0,0,t,n);const r=p.getImageData(0,0,t,n),s=r.data,u=N?+N.value:0,v=V?+V.value:0,g=z?+z.value:255,{r:L,g:$,b:k}=Le(ge);for(let h=0;h<s.length;h+=4){let y=.2126*s[h]+.7152*s[h+1]+.0722*s[h+2];y=(y-128)*(u/100+1)+128,y=Math.max(0,Math.min(255,y));const $e=(y-0)/255*(g-v)+v;let J=Math.floor($e/64);J=Math.max(0,Math.min(3,J));const K=[0,85,170,255][J];s[h]=K/255*L,s[h+1]=K/255*$,s[h+2]=K/255*k}p.putImageData(r,0,0)}function Le(t){const n=parseInt(t.slice(1),16);return{r:n>>16&255,g:n>>8&255,b:n&255}}ae&&(ae.onclick=()=>{m&&(m.textContent='Image ready. Click "Finalize & Send All" to complete submission.',m.style.color="#33ff33")}),se&&(se.onclick=async()=>{if(m){m.textContent="Uploading...",m.style.color="#33ff33";try{await e.getIdToken(!0),console.log("Token refreshed before upload");const t=[],n={text:(Y==null?void 0:Y.value.trim())||null,alt:(Q==null?void 0:Q.value.trim())||"",imageURL:null,audioURL:null,timestamp:Date.now(),woobieName:E};if(T){console.log(`Attempting to upload audio to: tier2/${a}/${o}-audio.webm`);const r=re(ue,`tier2/${a}/${o}-audio.webm`);t.push(le(r,T).then(()=>ie(r).then(s=>n.audioURL=s)).catch(s=>{throw console.error("Audio upload failed:",s),s}))}if(D&&c&&p){console.log(`Attempting to upload image to: tier2/${a}/${o}-image.png`);const r=document.createElement("canvas");r.width=c.width,r.height=c.height,r.getContext("2d").drawImage(c,0,0);const u=await new Promise(g=>r.toBlob(g,"image/png")),v=re(ue,`tier2/${a}/${o}-image.png`);t.push(le(v,u).then(()=>ie(v).then(g=>n.imageURL=g)).catch(g=>{throw console.error("Image upload failed:",g),g}))}console.log("Starting uploads..."),await Promise.all(t),console.log("All uploads completed successfully"),await f(q,n),await f(A,!0),await ce(x,{stage:"tier2-reward-sent"}),m.textContent="✅ Reward sent! Redirecting...",m.style.color="#33ff33",setTimeout(()=>{window.location.href="/tier2/reveal.html"},2e3)}catch(t){console.error("Error submitting reward:",t),m&&(m.textContent=`❌ Error uploading: ${t.message}`,m.style.color="#ff6666")}}}),ve(C,t=>{const n=t.val();n&&Object.keys(n).length>=2&&(Se(C),window.location.href="/tier2/reveal.html")})});let d=localStorage.getItem("woobieMatchID"),w=localStorage.getItem("woobieUsername"),he=localStorage.getItem("woobieBio");d||(d=prompt("Missing match ID — please enter your match ID:"),localStorage.setItem("woobieMatchID",d));w||(w=prompt("Missing username — please enter your username:"),localStorage.setItem("woobieUsername",w));f(l(i,`matches/${d}/meta/${w}`),{stage:"tier1b",joinedAt:Date.now()});const qe=l(i,`matches/${d}/tier1b/${w}`),Ae=l(i,`matches/${d}/tier1b`),ke=l(i,`matches/${d}/tier1bLetters/${w}`);l(i,`matches/${d}/tier1bLetters`);const He=l(i,`matches/${d}/bios/${w}`);l(i,`matches/${d}/bios`);const Me=l(i,`matches/${d}/tier1bVotes/${w}`),je=l(i,`matches/${d}/tier1bVotes`),ee=["What's something you're working on improving?","How do you recharge after a stressful day?","What's a non-negotiable value in your life?","What do you want more of in your future?","What makes you feel heard?","What's a memory you'd share to explain who you are?"];let te=[],M=0;const ye=document.getElementById("question-block"),fe=document.getElementById("question-number"),pe=document.getElementById("question-text"),S=document.getElementById("answer"),we=document.getElementById("submit-btn"),F=document.getElementById("completion-message"),O=document.getElementById("message-block"),U=document.getElementById("letter-input"),be=document.getElementById("letter-count"),Ie=document.getElementById("letter-message");function xe(){var e;if(M>=ee.length){ye&&(ye.style.display="none"),F&&(F.style.display="block"),f(qe,te),We();return}fe&&(fe.textContent=`Question ${M+1} of ${ee.length}`),pe&&(pe.textContent=ee[M]),S&&(S.value=((e=te[M])==null?void 0:e.value)||"")}we&&(we.onclick=()=>{const e=S==null?void 0:S.value.trim();e&&(te[M]={format:"text",value:e},M++,xe())});he&&f(He,he);function We(){Ue(Ae).then(e=>{const o=e.val();o&&Object.keys(o).length>=2&&F&&O&&(F.style.display="none",O.style.display="block")})}U&&(U.oninput=()=>{const e=U.value.trim().split(/\s+/).filter(Boolean);be&&(be.textContent=`${e.length} / 250 words`)});const Be=document.getElementById("submit-letter");Be&&U&&Ie&&(Be.onclick=()=>{const e=U.value.trim(),o=e.split(/\s+/).filter(Boolean),a=/(.)\1{20,}/.test(e);if(o.length>250||a){Ie.textContent="Please keep your message under 250 words with no repeated spam characters.";return}f(ke,e),f(Me,!0),Ce()});const Ee=document.getElementById("skip-letter");Ee&&(Ee.onclick=()=>{f(ke,""),f(Me,!0),Ce()});function Ce(){ve(je,e=>{const o=e.val();!o||Object.keys(o).length<2||(Object.values(o).every(a=>a===!0)?window.location.href="/tier2/index.html":O&&(O.innerHTML="<h2>Unfortunately, your match wasn't ready to continue. 😔</h2>"))})}xe();document.addEventListener("DOMContentLoaded",()=>{[document.querySelector('label[for="image-file"]'),document.querySelector('label[for="audio-file"]')].forEach(o=>{o&&o.addEventListener("click",()=>{o.classList.add("clicked"),setTimeout(()=>o.classList.remove("clicked"),200)})})});
