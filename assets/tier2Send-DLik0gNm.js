import{a as $e,g as K,r as i,d as l,D as We,o as De,u as ce,j as ie,l as le,m as ue,b as $,c as Me,e as Ae}from"./firebase-config-CQBF9bbN.js";/* empty css              */import"./logout-BHqC0Y9t.js";import"./feedback-CLnNHjql.js";function L(t){return t.replace(new RegExp("(\\p{Emoji_Presentation}|\\p{Emoji}\\uFE0F)","gu"),o=>`<span class="woobie-emoji">${o}</span>`)}document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelector("h1");t.innerHTML=L(t.textContent);const o=document.getElementById("logout-button");o.innerHTML=L(o.textContent),document.querySelectorAll("h3").forEach(M=>{M.innerHTML=L(M.textContent)});const a=document.getElementById("chat-cancel-upload");a&&(a.innerHTML=L(a.textContent));const d=document.getElementById("submit-reward");d.innerHTML=L(d.textContent);const y=document.getElementById("close-story");y.innerHTML=L(y.textContent);const w=document.querySelector("#our-story-modal h2");w.innerHTML=L(w.textContent);const m=document.getElementById("our-story-button");m.innerHTML=L(m.textContent)});document.getElementById("image-upload").addEventListener("change",t=>{t.target.files&&t.target.files[0]&&(document.body.classList.add("has-image"),document.getElementById("image-adjust-wrap").style.display="flex")});const de=document.getElementById("chat-cancel-upload");de&&(de.onclick=()=>{const t=document.getElementById("image-upload");t&&(t.value=""),document.getElementById("image-adjust-wrap").style.display="none",document.body.classList.remove("has-image");const o=document.getElementById("chat-preview-canvas");o&&o.getContext("2d").clearRect(0,0,o.width,o.height);const a=document.getElementById("chat-contrast"),d=document.getElementById("output-black"),y=document.getElementById("output-white"),w=document.getElementById("chat-image-alt");a&&(a.value=0),d&&(d.value=0),y&&(y.value=255),w&&(w.value="")});const me=document.getElementById("our-story-button"),ge=document.getElementById("close-story"),q=document.getElementById("story-content"),ne=document.getElementById("our-story-modal");function Se(t){return t.replace(new RegExp("(\\p{Emoji_Presentation}|\\p{Emoji}\\uFE0F)","gu"),o=>`<span class="woobie-emoji">${o}</span>`)}me&&ne&&q&&ge&&(me.onclick=async()=>{var t,o,a,d,y,w;ne.style.display="block",q.innerHTML="<p>Loading...</p>";try{const m=localStorage.getItem("woobieMatchID"),M=$e.currentUser;if(!M||!m){q.innerHTML="<p>Error loading story.</p>";return}const T=M.uid,[u,P,F]=await Promise.all([K(i(l,`matches/${m}/tier1a`)),K(i(l,`matches/${m}/tier1b`)),K(i(l,`matches/${m}/tier2`))]),D=u.val()||{},A=P.val()||{},S=F.val()||{},x=Object.keys(S).find(e=>e!==T);if(!x){q.innerHTML="<p>Waiting for your match to complete their answers...</p>";return}const I=["What's something you're proud of recently?","How would a friend describe you?","What does comfort look like to you?","When do you feel most alive?","What's a recent thought you can't shake?","How do you usually show someone you care?"],b=["What's something you're working on improving?","How do you recharge after a stressful day?","What's a non-negotiable value in your life?","What do you want more of in your future?","What makes you feel heard?","What's a memory you'd share to explain who you are?"],U=["What's a moment in your life that changed the way you see the world?","How do you show someone you care about them?","What's something people often misunderstand about you?","When do you feel most like yourself?","What's one thing you wish more people asked you about?","What makes you feel seen or understood?","What's a belief you held strongly that changed over time?","What's one thing you never get tired of talking about?","When have you felt the most brave?","What do you wish someone had told you earlier in life?","What kind of people do you feel safest around?","What's something you've forgiven yourself for?"];let f="<h3>📘 Tier 1a Answers</h3>";const B=((t=D[T])==null?void 0:t.answers)||[],E=((o=D[x])==null?void 0:o.answers)||[];I.forEach((e,n)=>{var c,g;const r=Array.isArray(B)&&((c=B[n])==null?void 0:c.value)||B[n],s=Array.isArray(E)&&((g=E[n])==null?void 0:g.value)||E[n];f+=`
              <details><summary><strong>${e}</strong></summary>
              <p><strong>You:</strong> ${r||"<em>No answer</em>"}</p>
              <p><strong>Your Match:</strong> ${s||"<em>No answer</em>"}</p>
              </details>`}),f+="<h3>📘 Tier 1b Answers</h3>";const H=((a=A[T])==null?void 0:a.answers)||[],O=((d=A[x])==null?void 0:d.answers)||[];b.forEach((e,n)=>{var c,g;const r=((c=H[n])==null?void 0:c.value)||H[n]||"<em>No answer</em>",s=((g=O[n])==null?void 0:g.value)||O[n]||"<em>No answer</em>";f+=`
              <details><summary><strong>${e}</strong></summary>
              <p><strong>You:</strong> ${r}</p>
              <p><strong>Your Match:</strong> ${s}</p>
              </details>`}),f+="<h3>📘 Tier 2 Answers</h3>";const Y=((y=S[T])==null?void 0:y.answers)||[],ee=((w=S[x])==null?void 0:w.answers)||[];U.forEach((e,n)=>{f+=`
              <details><summary><strong>${e}</strong></summary>
              <p><strong>You:</strong> ${Y[n]||"<em>No answer</em>"}</p>
              <p><strong>Your Match:</strong> ${ee[n]||"<em>No answer</em>"}</p>
              </details>`}),q.innerHTML=Se(f)}catch(m){q.innerHTML='<p style="color:red;">Error loading story.</p>',console.error(m)}},ge.onclick=()=>{ne.style.display="none"});const he=We();let C=null,z=null,ye="#33ff33",_=null,W=null,ae=[];De($e,async t=>{if(!t){alert("You must be logged in to participate. Redirecting to login."),window.location.href="/auth/login.html";return}const o=t.uid,a=localStorage.getItem("woobieMatchID"),d=localStorage.getItem("woobieUsername");if(!a||!d){alert("Missing critical session data (Match ID or Woobie Name). Please restart."),window.location.href="/name-picker/index.html";return}console.log(`[Tier2 Send INIT] MatchID: ${a}, UserID: ${o}, WoobieName: ${d}`);try{const e=await t.getIdTokenResult(!0);console.log("User custom claims:",e.claims),console.log("Match access claims:",e.claims.matchAccess),console.log("Does user have access to this match?",e.claims.matchAccess&&e.claims.matchAccess.includes(a))}catch(e){console.error("Error getting ID token:",e)}const y=i(l,`users/${o}/currentMatch`);ce(y,{stage:"tier2-send"});const w=i(l,`matches/${a}/tier2Rewards/${o}`),m=i(l,`matches/${a}/tier2Votes/${o}`),M=i(l,`matches/${a}/tier2Rewards`),T=document.getElementById("image-upload"),u=document.getElementById("chat-preview-canvas"),P=document.getElementById("chat-contrast"),F=document.getElementById("output-black"),D=document.getElementById("output-white"),A=document.getElementById("chat-image-alt"),S=document.querySelectorAll(".color-btn"),x=document.getElementById("reward-text"),I=document.getElementById("audio-preview"),b=document.getElementById("status-msg"),U=document.getElementById("start-recording"),f=document.getElementById("stop-recording"),B=document.getElementById("play-audio"),E=document.getElementById("reset-audio"),H=document.getElementById("recording-indicator"),O=document.getElementById("submit-reward");u&&(C=u.getContext("2d",{willReadFrequently:!0})),U&&f&&B&&E&&I&&H&&(U.onclick=async()=>{try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});W=new MediaRecorder(e),ae=[],W.ondataavailable=n=>ae.push(n.data),W.onstop=()=>{_=new Blob(ae,{type:"audio/webm"}),I.src=URL.createObjectURL(_),I.style.display="block",B.disabled=!1,E.disabled=!1},W.start(),H.style.display="block",U.disabled=!0,f.disabled=!1}catch(e){console.error("Error accessing microphone:",e),alert("Could not access microphone. Please check your permissions.")}},f.onclick=()=>{W&&W.state==="recording"&&(W.stop(),H.style.display="none",U.disabled=!1,f.disabled=!0)},B.onclick=()=>{I.src&&I.play()},E.onclick=()=>{_=null,I.src="",I.style.display="none",B.disabled=!0,E.disabled=!0}),S&&S.forEach(e=>{e.onclick=()=>{ye=e.dataset.color,Y()}}),[P,F,D].forEach(e=>{e&&(e.oninput=Y)}),T&&(T.onchange=e=>{const n=e.target.files[0];if(!n)return;const r=new FileReader;r.onload=s=>{const c=new Image;c.onload=()=>{const p=128/Math.max(c.width,c.height),V=Math.round(c.width*p),Q=Math.round(c.height*p),j=document.createElement("canvas");j.width=V,j.height=Q,j.getContext("2d").drawImage(c,0,0,V,Q);const k=new Image;k.onload=()=>{z=k,u&&C&&(u.width=V*4,u.height=Q*4,C.drawImage(z,0,0,u.width,u.height),Y())},k.src=j.toDataURL()},c.src=s.target.result},r.readAsDataURL(n)});function Y(){if(!z||!C||!u)return;const{width:e,height:n}=u;C.drawImage(z,0,0,e,n);const r=C.getImageData(0,0,e,n),s=r.data,c=P?+P.value:0,g=F?+F.value:0,p=D?+D.value:255,{r:V,g:Q,b:j}=ee(ye);for(let v=0;v<s.length;v+=4){let k=.2126*s[v]+.7152*s[v+1]+.0722*s[v+2];k=(k-128)*(c/100+1)+128,k=Math.max(0,Math.min(255,k));const Te=(k-0)/255*(p-g)+g;let te=Math.floor(Te/64);te=Math.max(0,Math.min(3,te));const oe=[0,85,170,255][te];s[v]=oe/255*V,s[v+1]=oe/255*Q,s[v+2]=oe/255*j}C.putImageData(r,0,0)}function ee(e){const n=parseInt(e.slice(1),16);return{r:n>>16&255,g:n>>8&255,b:n&255}}O&&(O.onclick=async()=>{if(b){b.textContent="Uploading...",b.style.color="#33ff33";try{await t.getIdToken(!0),console.log("Token refreshed before upload");const e=[],n={text:(x==null?void 0:x.value.trim())||null,alt:(A==null?void 0:A.value.trim())||"",imageURL:null,audioURL:null,timestamp:Date.now(),woobieName:d};if(_){console.log(`Attempting to upload audio to: tier2/${a}/${o}-audio.webm`);const r=ie(he,`tier2/${a}/${o}-audio.webm`);e.push(le(r,_).then(()=>ue(r).then(s=>n.audioURL=s)).catch(s=>{throw console.error("Audio upload failed:",s),s}))}if(z&&u&&C){console.log(`Attempting to upload image to: tier2/${a}/${o}-image.png`);const r=document.createElement("canvas");r.width=u.width,r.height=u.height,r.getContext("2d").drawImage(u,0,0);const c=await new Promise(p=>r.toBlob(p,"image/png")),g=ie(he,`tier2/${a}/${o}-image.png`);e.push(le(g,c).then(()=>ue(g).then(p=>n.imageURL=p)).catch(p=>{throw console.error("Image upload failed:",p),p}))}console.log("Starting uploads..."),await Promise.all(e),console.log("All uploads completed successfully"),await $(w,n),await $(m,!0),await ce(y,{stage:"tier2-reward-sent"}),b.textContent="✅ Reward sent! Redirecting...",b.style.color="#33ff33",setTimeout(()=>{window.location.href="/tier2/reveal.html"},2e3)}catch(e){console.error("Error submitting reward:",e),b&&(b.textContent=`❌ Error uploading: ${e.message}`,b.style.color="#ff6666")}}}),Me(M,e=>{const n=e.val();n&&Object.keys(n).length>=2&&(Ae(M),window.location.href="/tier2/reveal.html")})});let h=localStorage.getItem("woobieMatchID"),R=localStorage.getItem("woobieUsername"),fe=localStorage.getItem("woobieBio");h||(h=prompt("Missing match ID — please enter your match ID:"),localStorage.setItem("woobieMatchID",h));R||(R=prompt("Missing username — please enter your username:"),localStorage.setItem("woobieUsername",R));$(i(l,`matches/${h}/meta/${R}`),{stage:"tier1b",joinedAt:Date.now()});const Ue=i(l,`matches/${h}/tier1b/${R}`),He=i(l,`matches/${h}/tier1b`),xe=i(l,`matches/${h}/tier1bLetters/${R}`);i(l,`matches/${h}/tier1bLetters`);const je=i(l,`matches/${h}/bios/${R}`);i(l,`matches/${h}/bios`);const Le=i(l,`matches/${h}/tier1bVotes/${R}`),qe=i(l,`matches/${h}/tier1bVotes`),se=["What's something you're working on improving?","How do you recharge after a stressful day?","What's a non-negotiable value in your life?","What do you want more of in your future?","What makes you feel heard?","What's a memory you'd share to explain who you are?"];let re=[],N=0;const pe=document.getElementById("question-block"),we=document.getElementById("question-number"),be=document.getElementById("question-text"),G=document.getElementById("answer"),Ie=document.getElementById("submit-btn"),X=document.getElementById("completion-message"),Z=document.getElementById("message-block"),J=document.getElementById("letter-input"),Be=document.getElementById("letter-count"),Ee=document.getElementById("letter-message");function Ce(){var t;if(N>=se.length){pe&&(pe.style.display="none"),X&&(X.style.display="block"),$(Ue,re),Ne();return}we&&(we.textContent=`Question ${N+1} of ${se.length}`),be&&(be.textContent=se[N]),G&&(G.value=((t=re[N])==null?void 0:t.value)||"")}Ie&&(Ie.onclick=()=>{const t=G==null?void 0:G.value.trim();t&&(re[N]={format:"text",value:t},N++,Ce())});fe&&$(je,fe);function Ne(){K(He).then(t=>{const o=t.val();o&&Object.keys(o).length>=2&&X&&Z&&(X.style.display="none",Z.style.display="block")})}J&&(J.oninput=()=>{const t=J.value.trim().split(/\s+/).filter(Boolean);Be&&(Be.textContent=`${t.length} / 250 words`)});const ve=document.getElementById("submit-letter");ve&&J&&Ee&&(ve.onclick=()=>{const t=J.value.trim(),o=t.split(/\s+/).filter(Boolean),a=/(.)\1{20,}/.test(t);if(o.length>250||a){Ee.textContent="Please keep your message under 250 words with no repeated spam characters.";return}$(xe,t),$(Le,!0),Re()});const ke=document.getElementById("skip-letter");ke&&(ke.onclick=()=>{$(xe,""),$(Le,!0),Re()});function Re(){Me(qe,t=>{const o=t.val();!o||Object.keys(o).length<2||(Object.values(o).every(a=>a===!0)?window.location.href="/tier2/index.html":Z&&(Z.innerHTML="<h2>Unfortunately, your match wasn't ready to continue. 😔</h2>"))})}Ce();document.addEventListener("DOMContentLoaded",()=>{[document.querySelector('label[for="image-file"]'),document.querySelector('label[for="audio-file"]')].forEach(o=>{o&&o.addEventListener("click",()=>{o.classList.add("clicked"),setTimeout(()=>o.classList.remove("clicked"),200)})})});
